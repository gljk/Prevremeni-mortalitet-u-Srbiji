---
title: "Prevremeni mortalitet u Srbiji"
author: "Marko Galjak"
date: "1/1/2022"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R kod korišćen za sređivanje podataka
U doktrorskoj diesrtaciji su korišćeni detaljni podaci o smrti u Srbiji za 6 godina od 2015. do 2020. godine
Datoteka za svaku godinu ima više od 80.000 redova podataka jer su podaci dati po polu, starosti, opštini i tačnom (četvroznačnom) uzroku smrti.
U pripremi podatka prvo ih objedinjujemo u jedan veliki dataframe i nakon toga svaki red svrtstavamo po kategorijama Međunarodne kategorizacije bolesti i prema tome da li su uzroci smrti oni koji se mogu izbeći, preventabilni ili predupredivi.

```{r data_consolidation, message=FALSE, warning=FALSE}
require(tidyverse)
require(iterators)
require(openxlsx)
require(ggpattern)
require(spdep)
require(rgdal)
require(maptools)
require(ggthemes)
require(geojsonio)

#Učitavamo datoteke
mort_podaci_postoje <- file.exists("umrli15-20.xslx")
if (!mort_podaci_postoje) {
  umrli15 <- read.xlsx("RZS/Umrli_2015.xlsx")
  umrli16 <- read.xlsx("RZS/Umrli_2016.xlsx")
  umrli17 <- read.xlsx("RZS/Umrli_2017.xlsx")
  umrli19 <- read.xlsx("RZS/Umrli_2019.xlsx")
  umrli18 <- read.xlsx("RZS/Umrli_2018.xlsx")
  umrli20 <- read.xlsx("RZS/Umrli_2020.xlsx")
  
  colnames(umrli15)[2] <- "Opstina"
  colnames(umrli16)[2] <- "Opstina"
  colnames(umrli17)[2] <- "Opstina"
  colnames(umrli18)[2] <- "Opstina"
  colnames(umrli19)[2] <- "Opstina"
  colnames(umrli20)[2] <- "Opstina"
  
  umrli <- rbind(umrli15,
                 umrli16,
                 umrli17,
                 umrli18,
                 umrli19,
                 umrli20)
  
  rm(list = c(
    "umrli15",
    "umrli16",
    "umrli17",
    "umrli18",
    "umrli19",
    "umrli20"
  ))
  d <-
    as.data.frame(
      read.csv(
        file = "Mortalty Coding/Diagnosis2.txt",
        sep = "\t",
        quote = '""',
        header = F,
        stringsAsFactors = F,
        encoding = "UTF-8"
      )
    )
  d <- d[, 1:5]
  colnames(d) <- c("Chapter", "List", "Cause", "Title", "TilteSR")
  d <- d[d$List == 103, ]
  
  ch <-
    as.data.frame(
      read.csv(
        file = "Mortalty Coding/CodingChapters2.txt",
        sep = "\t",
        quote = '""',
        header = F,
        stringsAsFactors = F,
        encoding = "UTF-8"
      )
    )
  colnames(ch) <-
    c("Chapeter", "List", "Title", "TilteSR", "TilteSRCyr")
  ch <- ch[ch$List == 103, c(1, 3)]
  colnames(ch)[1] <- "Chapter"
  amenmort <- read_csv(file = "Mortalty Coding/amort.csv")
  amenmort$Cause <-
    gsub(pattern = "[.]",
         replacement = "",
         x = amenmort$Cause)
  
  ages <- list(
    `0-14` = 0:14,
    `0-19` = 0:19,
    `0-44` = 0:44,
    `0-74` = 0:74,
    `1-14` = 1:14,
    All = 1:150
  )
  
  MortClassifier <-
    function(dataset = NULL,
             cause = NULL,
             age = NULL,
             ages = NULL,
             i = NULL) {
      if (nrow(amenmort[amenmort$Cause == cause,]) != 0) {
        if (age %in% unlist(ages[as.character(amenmort[amenmort$Cause == cause, "AGE"])])) {
          return(cbind(data.frame(rn = i), amenmort[amenmort$Cause == cause, c(5, 6)]))
        }
        
      } else{
        if (nrow(amenmort[amenmort$Cause == substring(cause, 1, 3),]) != 0) {
          if (age %in% unlist(ages[as.character(amenmort[amenmort$Cause == substring(cause, 1, 3), "AGE"])])) {
            return(cbind(data.frame(rn = i), amenmort[amenmort$Cause == substring(cause, 1, 3), c(5, 6)]))
          }
        }
      }
      return(data.frame(
        rn = i,
        Amenable = 0,
        Preventable = 0
      ))
    }
  
  
  require(foreach)
  library(doParallel)
  
  cl <- makeCluster(11)
  registerDoParallel(cl)
  
  s2 <- data.frame(
    rn = 1:nrow(umrli),
    Amenable = NA,
    Preventable = NA
  )
  for (i in 1:nrow(umrli)) {
    s2[i, ] <-
      MortClassifier(
        dataset = amenmort,
        cause = umrli$Uzrok.smrti[i],
        age = umrli$Starost[i],
        ages = ages,
        i = i
      )
    
  }
  
  umrli <- cbind(umrli, s2)
  umrli$rn <- NULL
  umrli$Avoidable <- umrli$Preventable + umrli$Amenable
  umrli$Avoidable <- ifelse(umrli$Avoidable > 0, 1, 0)
  
  write.xlsx(umrli, "umrli15-20Avoidable.xlsx")
} else {
  umrli <- read.xlsx("umrli15-20Avoidable.xlsx")
}

#Sređivanje Grada Niša
opstine_nisa <-
  c("71285", "71307", "71315", "71323", "71331") #5 opština Grada Niša
umrli[umrli$Opstina %in% opstine_nisa, "Opstina"] <- "79022"

#Sređivanje Grada Novog Sada 

opstine_novog_sada <-
  c("80284", "80519")

umrli[umrli$Opstina %in% opstine_novog_sada, "Opstina"] <- "89010"


#Učitavanje podataka o proceni broja stanovnika sredini godine.

pop <- read.csv("RZS/Populacija.csv", sep = ";")

#Dodati podaci sa šifarnikom opština

opstine <- read.csv(file = "Serbia Map/opstine.csv")




```

## Dodavanje podatka o broju stanovnika i računanje pokazatelja YPLL
U prvomd delu se učitavaju podaci o populaciji koji se mogu preuzeti sa portala otvorenih podataka RZS.
Takođe je U ovom delu je dato računanje pokazatelja izgubljenih godina potencijalnog života.


```{r standardization, message=FALSE, warning=FALSE }
#Učitavanja podataka o standardnoj evropskoj populaciji
standpop <- read.xlsx("StPopSingleYear.xlsx")
knitr::kable(standpop)

#svođenje standardne populacije na pondere (tako da zbir ukupne populacije bude 1)
standpop$stpop <- standpop$stpop / 1000000

#Kreiranje pondera za mlađe od 75 godina na osnovu standardne populacije koja ide do 85 godina.
sum(standpop$stpop) - sum(standpop$stpop[1:75])
standardpop75 <- standpop[1:75, ]
standardpop75$stpop <-
  (standpop$stpop[1:75] / sum(standpop$stpop[1:75]) * (sum(standpop$stpop) -
                                                         sum(standpop$stpop[1:75]))) + standpop$stpop[1:75]
standardpop75$stpop <- standardpop75$stpop / 1000000
colnames(standardpop75)[1] <- "Starost"

#Definisanje referentnog godišta za računanje pokazatelja izgubljenih godina potencijalnog života
YPLL_Age <- 75

#Računanje standardizovanog pokazatelja izgubljenih godina potencijalnog života umrlih od bolesti COVID-19
standardized_YPLL_Covid <- left_join(
  left_join(
    pop %>% filter(god == 2020, nPol == "Ukupno",!IDStarost %in% c("0", "V85")) %>% mutate(Starost =
                                                                                             as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by(Opstina = IDTer, Starost) %>% summarise(Pop =
                                                                                                                                                                                                    sum(vrednost)),
    umrli %>% filter(
      Godina.materijala == 2020,
      Starost < YPLL_Age,
      Uzrok.smrti %in% c("U071", "U072")
    ) %>%
      mutate(Broj.pojava = ifelse(is.na(Broj.pojava), 0, Broj.pojava)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Opstina, Starost) %>% summarise(YPLL = sum(YPLL))
  ) %>%
    mutate(YPLL = ifelse(is.na(YPLL), 0, YPLL)) %>% mutate(YPLLR = YPLL /
                                                             Pop * 100000),
  standardpop75
) %>% group_by(Opstina) %>% summarise(
  YPLLi = sum(YPLLR * stpop, na.rm = T),
  YPLLR = sum(YPLL) / sum(Pop) * 100000,
  YPLL = sum(YPLL),
  Pop = sum(Pop)
)

#Računanje standardizovanog pokazatelja izgubljenih godina potencijalnog života koji nisu umrli od bolesti COVID-19

standardized_YPLL_NoN_Covid <- left_join(
  left_join(
    pop %>% filter(god == 2020, nPol == "Ukupno",!IDStarost %in% c("0", "V85")) %>% mutate(Starost =
                                                                                             as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by(Opstina = IDTer, Starost) %>% summarise(Pop =
                                                                                                                                                                                                    sum(vrednost)),
    umrli %>% filter(Godina.materijala == 2020,
                     Starost < YPLL_Age) %>%
      mutate(Broj.pojava = ifelse(is.na(Broj.pojava), 0, Broj.pojava)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Opstina, Starost) %>% summarise(YPLL = sum(YPLL))
  ) %>%
    mutate(YPLL = ifelse(is.na(YPLL), 0, YPLL)) %>% mutate(YPLLR = YPLL /
                                                             Pop * 100000),
  standardpop75
) %>% group_by(Opstina) %>% summarise(
  YPLLi = sum(YPLLR * stpop, na.rm = T),
  YPLLR = sum(YPLL) / sum(Pop) * 100000,
  YPLL = sum(YPLL),
  Pop = sum(Pop)
)

#Računanje standardizovanog pokazatelja izgubljenih godina potencijalnog života umrlih
standardized_YPLL_TOTAL <- left_join(
  left_join(
    pop %>% filter(god == 2020, nPol == "Ukupno",!IDStarost %in% c("0", "V85")) %>% mutate(Starost =
                                                                                             as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by(Opstina = IDTer, Starost) %>% summarise(Pop =
                                                                                                                                                                                                    sum(vrednost)),
    umrli %>% filter(Godina.materijala == 2020,
                     Starost < YPLL_Age) %>%
      mutate(Broj.pojava = ifelse(is.na(Broj.pojava), 0, Broj.pojava)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Opstina, Starost) %>% summarise(YPLL = sum(YPLL))
  ) %>%
    mutate(YPLL = ifelse(is.na(YPLL), 0, YPLL)) %>% mutate(YPLLR = YPLL /
                                                             Pop * 100000),
  standardpop75
) %>% group_by(Opstina) %>% summarise(
  YPLLi = sum(YPLLR * stpop, na.rm = T),
  YPLLR = sum(YPLL) / sum(Pop) * 100000,
  YPLL = sum(YPLL),
  Pop = sum(Pop)
)

#Računanje standardizovanog pokazatelja izgubljenih godina potencijalnog života umrlih 2019
standardized_YPLL_TOTAL_2017_2019 <- left_join(
  left_join(
    pop %>% filter(god %in% c(2017,2019, 2019) , nPol == "Ukupno",!IDStarost %in% c("0", "V85")) %>% mutate(Starost =
                                                                                             as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by(Opstina = IDTer, Starost) %>% summarise(Pop =
                                                                                                                                                                                                    sum(vrednost)),
    umrli %>% filter(Godina.materijala %in% c(2017,2019, 2019) ,
                     Starost < YPLL_Age) %>%
      mutate(Broj.pojava = ifelse(is.na(Broj.pojava), 0, Broj.pojava)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Opstina, Starost) %>% summarise(YPLL = sum(YPLL))
  ) %>%
    mutate(YPLL = ifelse(is.na(YPLL), 0, YPLL)) %>% mutate(YPLLR = YPLL /
                                                             Pop * 100000),
  standardpop75
) %>% group_by(Opstina) %>% summarise(
  YPLLi = sum(YPLLR * stpop, na.rm = T),
  YPLLR = sum(YPLL) / sum(Pop) * 100000,
  YPLL = sum(YPLL),
  Pop = sum(Pop)
)

#Računanje standardizovanog pokazatelja izgubljenih godina potencijalnog života umrlih od uzroka smrti koji se mogu izbeći

standardized_YPLL_Avoidable <- left_join(
  left_join(
    pop %>% filter(god == 2020, nPol == "Ukupno",!IDStarost %in% c("0", "V85")) %>% mutate(Starost =
                                                                                             as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by(Opstina = IDTer, Starost) %>% summarise(Pop =
                                                                                                                                                                                                    sum(vrednost)),
    umrli %>% filter(Godina.materijala == 2020, Avoidable == 1,
                     Starost < YPLL_Age) %>%
      mutate(Broj.pojava = ifelse(is.na(Broj.pojava), 0, Broj.pojava)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Opstina, Starost) %>% summarise(YPLL = sum(YPLL))
  ) %>%
    mutate(YPLL = ifelse(is.na(YPLL), 0, YPLL)) %>% mutate(YPLLR = YPLL /
                                                             Pop * 100000),
  standardpop75
) %>% group_by(Opstina) %>% summarise(
  YPLLi = sum(YPLLR * stpop, na.rm = T),
  YPLLR = sum(YPLL) / sum(Pop) * 100000,
  YPLL = sum(YPLL),
  Pop = sum(Pop)
)

#Računanje standardizovanog pokazatelja izgubljenih godina potencijalnog života umrlih od uzroka smrti koji se mogu izbeći prevencijom

standardized_YPLL_Preventable <- left_join(
  left_join(
    pop %>% filter(god == 2020, nPol == "Ukupno",!IDStarost %in% c("0", "V85")) %>% mutate(Starost =
                                                                                             as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by(Opstina = IDTer, Starost) %>% summarise(Pop =
                                                                                                                                                                                                    sum(vrednost)),
    umrli %>% filter(Godina.materijala == 2020, Preventable == 1,
                     Starost < YPLL_Age) %>%
      mutate(Broj.pojava = ifelse(is.na(Broj.pojava), 0, Broj.pojava)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Opstina, Starost) %>% summarise(YPLL = sum(YPLL))
  ) %>%
    mutate(YPLL = ifelse(is.na(YPLL), 0, YPLL)) %>% mutate(YPLLR = YPLL /
                                                             Pop * 100000),
  standardpop75
) %>% group_by(Opstina) %>% summarise(
  YPLLi = sum(YPLLR * stpop, na.rm = T),
  YPLLR = sum(YPLL) / sum(Pop) * 100000,
  YPLL = sum(YPLL),
  Pop = sum(Pop)
)

#Računanje standardizovanog pokazatelja izgubljenih godina potencijalnog života umrlih od uzroka smrti koji se mogu izbeći adekvatnom i pravovremenom zdravstvenom zaštitom

standardized_YPLL_Amenable <- left_join(
  left_join(
    pop %>% filter(god == 2020, nPol == "Ukupno",!IDStarost %in% c("0", "V85")) %>% mutate(Starost =
                                                                                             as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by(Opstina = IDTer, Starost) %>% summarise(Pop =
                                                                                                                                                                                                    sum(vrednost)),
    umrli %>% filter(Godina.materijala == 2020, Amenable == 1,
                     Starost < YPLL_Age) %>%
      mutate(Broj.pojava = ifelse(is.na(Broj.pojava), 0, Broj.pojava)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Opstina, Starost) %>% summarise(YPLL = sum(YPLL))
  ) %>%
    mutate(YPLL = ifelse(is.na(YPLL), 0, YPLL)) %>% mutate(YPLLR = YPLL /
                                                             Pop * 100000),
  standardpop75
) %>% group_by(Opstina) %>% summarise(
  YPLLi = sum(YPLLR * stpop, na.rm = T),
  YPLLR = sum(YPLL) / sum(Pop) * 100000,
  YPLL = sum(YPLL),
  Pop = sum(Pop)
)

```
##Tabela o generalnim informacijama o prevremenom mortalitetu


```{r opsti_prevremeni, message=FALSE, warning=FALSE }

serbia_overall_premature <- left_join(
  umrli %>% filter(Starost < YPLL_Age) %>%
    mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Godina.materijala) %>% summarise(YPLL = sum(YPLL), `Umrli <75` = sum(Broj.pojava)),
  umrli %>% filter() %>% group_by(Godina.materijala) %>% summarise(Ukupno = sum(Broj.pojava))
) %>%  mutate(`Umrli <75 (%)` = round(`Umrli <75` / Ukupno * 100, 2))
knitr::kable(serbia_overall_premature)

```

```{r YPLL, message=FALSE, warning=FALSE}

#Populacija Srbije
popsr2020 <-
  pop %>% filter(god == 2020,
                 nPol == "Ukupno",
                 !IDStarost %in% c("0", "V85"),
                 IDTer == "RS") %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost <
                                                                                         75) %>% group_by() %>% summarise(Pop = sum(vrednost))
popsr2019 <-
  pop %>% filter(god == 2019,
                 nPol == "Ukupno",
                 !IDStarost %in% c("0", "V85"),
                 IDTer == "RS") %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost <
                                                                                         75) %>% group_by() %>% summarise(Pop = sum(vrednost))
popsr2018 <-
  pop %>% filter(god == 2018,
                 nPol == "Ukupno",
                 !IDStarost %in% c("0", "V85"),
                 IDTer == "RS") %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost <
                                                                                         75) %>% group_by() %>% summarise(Pop = sum(vrednost))
popsr2017 <-
  pop %>% filter(god == 2017,
                 nPol == "Ukupno",
                 !IDStarost %in% c("0", "V85"),
                 IDTer == "RS") %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost <
                                                                                         75) %>% group_by() %>% summarise(Pop = sum(vrednost))

popsr2020m <-
  pop %>% filter(god == 2020,!IDStarost %in% c("0", "V85"), IDTer == "RS", IDPol ==
                   1) %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by() %>% summarise(Pop =
                                                                                                                          sum(vrednost))
popsr2020f <-
  pop %>% filter(god == 2020,!IDStarost %in% c("0", "V85"), IDTer == "RS", IDPol ==
                   2) %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by() %>% summarise(Pop =
                                                                                                                          sum(vrednost))



YPPL2020_C <- umrli %>% filter(Godina.materijala == 2020,
                               Starost < YPLL_Age,
                               Uzrok.smrti %in% c("U071", "U072")) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2020


YPPL2020_O <- umrli %>% filter(
  Godina.materijala == 2020,
  Starost < YPLL_Age,
  !Uzrok.smrti %in% c("U071", "U072"),
  Avoidable != 1
) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2020

YPPL2020_Avoidable <- umrli %>% filter(Godina.materijala == 2020,
                                       Starost < YPLL_Age, Avoidable == 1) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2020

umrli %>% filter(Godina.materijala == 2020,
                 Starost < YPLL_Age,) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2020


YPPL2019 <- umrli %>% filter(Godina.materijala == 2019,
                             Starost < YPLL_Age, Avoidable != 1) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2019

YPPL2019_Avoidable <- umrli %>% filter(Godina.materijala == 2019,
                                       Starost < YPLL_Age, Avoidable == 1) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2019


YPPL2018 <- umrli %>% filter(Godina.materijala == 2018,
                             Starost < YPLL_Age, Avoidable != 1) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2018

YPPL2018_Avoidable <- umrli %>% filter(Godina.materijala == 2018,
                                       Starost < YPLL_Age, Avoidable == 1) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2018


YPPL2017 <- umrli %>% filter(Godina.materijala == 2017,
                             Starost < YPLL_Age, Avoidable != 1) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2017

YPPL2017_Avoidable <- umrli %>% filter(Godina.materijala == 2017,
                                       Starost < YPLL_Age, Avoidable == 1) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2017




umrli %>% filter(Godina.materijala == 2020,
                 Uzrok.smrti %in% c("U071", "U072")) %>% filter((Pol == "1" &
                                                                   Starost < 65) | (Pol == "2" & Starost < 63)) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL))


covid_bar_plot <-
  data.frame(
    Year = c(2017, 2017, 2018, 2018, 2019, 2019, 2020, 2020, 2020),
    Type = c(
      "Other",
      "Avoidable",
      "Other",
      "Avoidable",
      "Other",
      "Avoidable",
      "SARS-CoV-2",
      "Avoidable",
      "Other"
    ),
    YPLL = unname(
      c(
        unlist(YPPL2017),
        unlist(YPPL2017_Avoidable),
        unlist(YPPL2018),
        unlist(YPPL2018_Avoidable),
        unlist(YPPL2019),
        unlist(YPPL2019_Avoidable),
        unlist(YPPL2020_C),
        unlist(YPPL2020_Avoidable),
        unlist(YPPL2020_O)
      )
    )
  )
covid_bar_plot$Type <-
  factor(covid_bar_plot$Type,
         levels = c("SARS-CoV-2", "Other", "Avoidable"))



fig2plos <-
  ggplot(covid_bar_plot , aes(x = Year, y = YPLL, fill = Type)) +
  geom_bar(position = "stack", stat = "identity") + coord_flip() +
  scale_fill_manual(values = c("#d95f02", "#1b9e77", "#7570b3")) + # c( "#abdda4", "#2b83ba", "#d7191c"))+
  #guides(NULL)+
  theme_tufte() + #theme(legend.position = "none",text=element_text(size=10,  family="TT Arial"))+
  theme(text = element_text(size = 10,  family = "TT Arial")) +
  scale_y_continuous(breaks = c(2000, 4000, 6000, 8000, 10000)) +
  #annotate("text", x=2020, y=9150,label="COVID-19", size=2.5, angle = 90, color="black" )+
  geom_hline(
    yintercept = c(2000, 4000, 6000, 8000, 10000),
    lwd = 1,
    color = "white"
  ) +
  ylab("Izgubljene godine potencijalnog života na 100.000 stanovnika") +
  xlab(NULL)
fig2plos

# ggsave(fig2plos,filename = "Figure2plos.svg", units = "mm", width = 175, height = 50)
# ggsave(fig2plos,filename = "figure2plos.png", units = "mm", width = 175, height = 50)
# ggsave(fig2plos,filename = "figure2plos.jpg", units = "mm", width = 175, height = 50, dpi = 600)
#

standardized_YPLL_Covid %>% group_by() %>% summarise(CV = sd(YPLLR) /
                                                       mean(YPLLR))

standardized_YPLL_NoN_Covid %>% group_by() %>% summarise(CV = sd(YPLLR) /
                                                           mean(YPLLR))

standardized_YPLL_TOTAL  %>% group_by() %>% summarise(CV = sd(YPLLR) /
                                                        mean(YPLLR))


#CPL

GDPPC2020 <- 7742

YPPLL <-
  umrli %>% filter(Godina.materijala == 2020,
                   Uzrok.smrti %in% c("U071", "U072")) %>% filter((Pol == "2" &
                                                                     Starost < 15)) %>% group_by() %>%  summarise(sum(Broj.pojava)) * (63 -
                                                                                                                                         15) +
  umrli %>% filter(Godina.materijala == 2020,
                   Uzrok.smrti %in% c("U071", "U072")) %>% filter((Pol == "1" &
                                                                     Starost < 15)) %>% group_by() %>%  summarise(sum(Broj.pojava)) * (65 -
                                                                                                                                         15) +
  
  
  umrli %>% filter(Godina.materijala == 2020,
                   Uzrok.smrti %in% c("U071", "U072")) %>% filter((Pol == "1" &
                                                                     Starost >= 15 &
                                                                     Starost < 65)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) +
  
  umrli %>% filter(Godina.materijala == 2020,
                   Uzrok.smrti %in% c("U071", "U072")) %>% filter((Pol == "2" &
                                                                     Starost >= 15 &
                                                                     Starost < 63)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL))

#
CPL = YPPLL * GDPPC2020


#Correlation test
forcor <-
  left_join(standardized_YPLL_NoN_Covid, standardized_YPLL_Covid, by = "Opstina")
cor.test(forcor$YPLLR.x, forcor$YPLLR.y, method = "spearman") 

```

```{r specificne_stope_smrtnosti_COVID,  message=FALSE, warning=FALSE}


ss_starost_covid <- left_join(
umrli %>% filter(
  Godina.materijala == 2020,
  Starost < YPLL_Age,
  Uzrok.smrti %in% c("U071", "U072")
) %>% dplyr::mutate(Starost=car::recode(Starost,'c("85", "86", "87", "88", 
"89", "90", "91", "92", "93", "94", "95", "96", "97", "98", "99", 
"100", "101", "102", "103", "104", "105", "106", "107", "108", 
"109", "111", "112", "114", "999")="85"'))%>% group_by(Starost,Pol) %>% summarise(Smrti=sum(Broj.pojava)),
pop %>% filter(god==2020, IDTer=="RS",IDPol!=0, IDStarost!=0) %>% mutate(Starost=c(0:85,0:85) , Pol=as.character(IDPol))) %>% 
  mutate(`Specifična stopa smrtnosti`=Smrti/vrednost*1000, Pol=ifelse(Pol=="1","Muški", "Ženski")) %>% ggplot() + geom_line(aes(x=Starost, y=`Specifična stopa smrtnosti`, col=Pol),size=1) + theme_tufte() + scale_color_manual(values = c("#377eb8", "#e41a1c"))+ scale_x_continuous(breaks=scales::extended_breaks(n=20)) +ylab("Specifična stopa smrtnosti (‰)") + scale_y_continuous(breaks = c(10, 20, 30, 40, 50, 60),limits = c(0,60))

ss_starost_2020 <- left_join(
umrli %>% filter(
  Godina.materijala == 2020,
  Starost < YPLL_Age,
) %>% dplyr::mutate(Starost=car::recode(Starost,'c("85", "86", "87", "88", 
"89", "90", "91", "92", "93", "94", "95", "96", "97", "98", "99", 
"100", "101", "102", "103", "104", "105", "106", "107", "108", 
"109", "111", "112", "114", "999")="85"'))%>% group_by(Starost,Pol) %>% summarise(Smrti=sum(Broj.pojava)),
pop %>% filter(god==2020, IDTer=="RS",IDPol!=0, IDStarost!=0) %>% mutate(Starost=c(0:85,0:85) , Pol=as.character(IDPol))) %>% 
  mutate(`Specifična stopa smrtnosti`=Smrti/vrednost*1000, Pol=ifelse(Pol=="1","Muški", "Ženski")) %>% ggplot() + geom_line(aes(x=Starost, y=`Specifična stopa smrtnosti`, col=Pol),size=1) + theme_tufte() + scale_color_manual(values = c("#377eb8", "#e41a1c"))+ scale_x_continuous(breaks=scales::extended_breaks(n=20)) +ylab("Specifična stopa smrtnosti (‰)")+ scale_y_continuous(breaks = c(10, 20, 30, 40, 50, 60),limits = c(0,60))


ss_starost_2017_2019 <- left_join(
umrli %>% filter(
  Godina.materijala %in% c(2017,2018,2019),
  Starost < YPLL_Age,
 # Uzrok.smrti %in% c("U071", "U072")
) %>% dplyr::mutate(Starost=car::recode(Starost,'c("85", "86", "87", "88", 
"89", "90", "91", "92", "93", "94", "95", "96", "97", "98", "99","100", "101", "102", "103", "104", "105", "106", "107", "108","109", "111", "112", "114", "999")="85"'))%>% group_by(Starost,Pol) %>% summarise(Smrti=sum(Broj.pojava)),
pop %>% filter(god %in% c(2017,2018,2019) , IDTer=="RS",IDPol!=0, IDStarost!=0) %>% mutate(Starost=rep(c(0:85,0:85),3) , Pol=as.character(IDPol))%>% group_by(Pol, Starost) %>% summarise(vrednost=sum(vrednost))) %>% mutate(`Specifična stopa smrtnosti`=Smrti/vrednost*1000, Pol=ifelse(Pol=="1","Muški", "Ženski")) %>% ggplot() + geom_line(aes(x=Starost, y=`Specifična stopa smrtnosti`, col=Pol),size=1) + theme_tufte()+ scale_color_manual(values = c("#377eb8", "#e41a1c"))+ scale_x_continuous(breaks=scales::extended_breaks(n=20)) + ylab("Specifična stopa smrtnosti (‰)") + scale_y_continuous(breaks = c(10, 20, 30, 40, 50, 60),limits = c(0,60))

left_join(
  left_join(
umrli %>% filter(
  Godina.materijala == 2020,
  Starost < YPLL_Age,
) %>% dplyr::mutate(Starost=car::recode(Starost,'c("85", "86", "87", "88", 
"89", "90", "91", "92", "93", "94", "95", "96", "97", "98", "99", 
"100", "101", "102", "103", "104", "105", "106", "107", "108", 
"109", "111", "112", "114", "999")="85"'))%>% group_by(Starost,Pol) %>% summarise(Smrti=sum(Broj.pojava)),
pop %>% filter(god==2020, IDTer=="RS",IDPol!=0, IDStarost!=0) %>% mutate(Starost=c(0:85,0:85) , Pol=as.character(IDPol))) %>% 
  mutate(`Specifična stopa smrtnosti`=Smrti/vrednost*1000, Pol=ifelse(Pol=="1","Muški", "Ženski")) %>% select(Starost,Pol, SS20 = `Specifična stopa smrtnosti`) ,

left_join(
umrli %>% filter(
  Godina.materijala %in% c(2017,2018,2019),
  Starost < YPLL_Age,
 # Uzrok.smrti %in% c("U071", "U072")
) %>% dplyr::mutate(Starost=car::recode(Starost,'c("85", "86", "87", "88", 
"89", "90", "91", "92", "93", "94", "95", "96", "97", "98", "99","100", "101", "102", "103", "104", "105", "106", "107", "108","109", "111", "112", "114", "999")="85"'))%>% group_by(Starost,Pol) %>% summarise(Smrti=sum(Broj.pojava)),
pop %>% filter(god %in% c(2017,2018,2019) , IDTer=="RS",IDPol!=0, IDStarost!=0) %>% mutate(Starost=rep(c(0:85,0:85),3) , Pol=as.character(IDPol))%>% group_by(Pol, Starost) %>% summarise(vrednost=sum(vrednost))) %>% mutate(`Specifična stopa smrtnosti`=Smrti/vrednost*1000, Pol=ifelse(Pol=="1","Muški", "Ženski")) %>% select(Starost,Pol, SS1719 = `Specifična stopa smrtnosti`) 
) %>% mutate(VisakSS=((SS20-SS1719) /SS20) *100)



ypll_ages_2020 <- umrli %>% filter(
    Godina.materijala == 2020,
    Starost < YPLL_Age) %>%
    mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Starost, Pol) %>% summarise(YPLL = sum(YPLL),Broj.pojava=sum(Broj.pojava) ) %>%  mutate( Pol=ifelse(Pol=="1","Muški", "Ženski")) %>%  ggplot() + geom_area(aes(x=Starost, y=YPLL, fill=Pol),size=1) + theme_tufte()+ scale_color_manual(values = c("#377eb8", "#e41a1c"))+ scale_x_continuous(breaks=scales::extended_breaks(n=20)) +scale_fill_manual(values = c("#377eb8", "#e41a1c"))+scale_y_continuous(breaks = c(5000, 10000, 15000, 20000, 25000),limits = c(0,25000))

ypll_ages_1719<- umrli %>% filter(
  Godina.materijala %in% c(2017,2018,2019),
    Starost < 65) %>%
    mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Starost, Pol) %>% summarise(YPLL = sum(YPLL)/3,Broj.pojava=sum(Broj.pojava)/3 ) %>%  mutate( Pol=ifelse(Pol=="1","Muški", "Ženski")) 

ypll_ages_1719 %>% ggplot() + geom_area(aes(x=Starost, y=YPLL, fill=Pol),size=1) + theme_tufte()+ scale_color_manual(values = c("#377eb8", "#e41a1c"))+ scale_x_continuous(breaks=scales::extended_breaks(n=20)) +scale_fill_manual(values = c("#377eb8", "#e41a1c")) +scale_y_continuous(breaks = c(5000, 10000, 15000, 20000, 25000),limits = c(0,25000))+ geom_vline(xintercept = findMedian(ypll_ages_1719$YPLL[ypll_ages_1719$Pol=="Muški"]))


ypll_ages_2020_cov <- umrli %>% filter(
    Godina.materijala == 2020,
    Starost < YPLL_Age,
    Uzrok.smrti %in% c("U071", "U072")) %>% 
    mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Starost, Pol) %>% summarise(YPLL = sum(YPLL),Broj.pojava=sum(Broj.pojava) ) %>%  mutate( Pol=ifelse(Pol=="1","Muški", "Ženski"))  
  
 ypll_ages_2020_cov%>%  ggplot() + geom_area(aes(x=Starost, y=YPLL, fill=Pol),size=1) + theme_tufte()+ scale_color_manual(values = c("#377eb8", "#e41a1c"))+ scale_x_continuous(breaks=scales::extended_breaks(n=20)) +scale_fill_manual(values = c("#377eb8", "#e41a1c"))+scale_y_continuous(breaks = c(5000, 10000, 15000, 20000, 25000),limits = c(0,25000)) + geom_vline(xintercept = findMedian(ypll_ages_2020_cov$YPLL[ypll_ages_2020_cov$Pol=="Ženski"]))



ggsave(ss_starost_covid,
        filename =  paste0(deparse(substitute(
          ss_starost_covid
        )), ".png"),
        units = "mm",
        width = 160,
        height = 80,
        dpi = 600
      )

ggsave(ss_starost_2017_2019,
        filename =  paste0(deparse(substitute(
          ss_starost_2017_2019
        )), ".png"),
        units = "mm",
        width = 160,
        height = 80,
        dpi = 600
      )

ggsave(ss_starost_2020,
        filename =  paste0(deparse(substitute(
          ss_starost_2020
        )), ".png"),
        units = "mm",
        width = 160,
        height = 80,
        dpi = 600
      )

```
##GIS Analiza
U ovom delu koristimo moranov globalni i lokalni indeks.

```{r GIS, message=FALSE, warning=FALSE}



Serbia <- readShapePoly("SRdrMap/Serbia.shp")
Serbia@data$code[39] <- 71366
#Sređivanje grada Niša
Serbia@data$code[Serbia@data$code == 71285] = 79022
SRMAP <- fortify(Serbia, region = "code")
SRMAP$region <- SRMAP$id

Kosovo <- geojson_read("Kosovo/Kosovo.geojson",  what = "sp")




spatial_processing <-
  function(map = NULL,
           foritfied_map = NULL,
           motality_dataframe = NULL,
           variable = NULL) {
    nb <- poly2nb(map, queen = TRUE)
    lw <- nb2listw(nb, style = "W", zero.policy = TRUE)
    
    x <-
      left_join(data.frame(Opstina = as.character(map@data$code)), motality_dataframe, by =
                  "Opstina")
    locmor <-
      localmoran(unname(unlist(c(x[, variable]))), lw, p.adjust.method = "bonferroni")
    locmor <- as.data.frame(locmor)
    return(left_join(
      foritfied_map,
      data.frame(
        Opstina = as.character(map@data$code),
        Ii = locmor$Ii,
        Pat = ifelse(locmor$`Pr(z != E(Ii))` < 0.1, "circle", "none")
      ),
      by = c("region" = "Opstina")
    ) %>% mutate(Pat = ifelse(Ii > 0 & Pat == "circle", "stripe", Pat)))
  }


getMorans <-
  function(map = NULL,
           mortality_dataframe = NULL,
           variable) {
    nb <- poly2nb(map, queen = TRUE)
    lw <- nb2listw(nb, style = "W", zero.policy = TRUE)
    x <-
      left_join(data.frame(Opstina = as.character(map@data$code)),
                mortality_dataframe,
                by = "Opstina")
    a <- moran.test(unname(unlist(c(x[, variable]))), lw)
    return(paste0(
      "Moran's I: ",
      round(a$estimate[1], 3),
      " (",
      scales::pvalue(a$p.value, accuracy = 0.0001, add_p = T),
      ")"
    ))
  }



buildMap <-
  function(map = NULL,
           foritfied_map = NULL,
           motality_dataframe = NULL,
           variable = NULL,
           paleta = NULL,
           direction = 1,
           save_map = T) {
    ggplotdata <-
      spatial_processing(
        map = map,
        foritfied_map = foritfied_map,
        motality_dataframe = motality_dataframe,
        variable = variable
      )
    built_map <-
      ggplot(data = left_join(foritfied_map, motality_dataframe, by = c("region" =
                                                                          "Opstina")),
             aes(x = long, y = lat)) +
      geom_map(
        map = foritfied_map,
        aes(
          map_id = id,
          x = long,
          y = lat,
          fill = round(YPLLR, 0),
          group = group,
          label = region
        ),
        color = "#808080",
        na.rm = F
      ) +
      coord_map("mercator") +
      scale_fill_distiller(palette = paleta, direction = direction) +
      guides(
        fill = guide_colorsteps(
          show.limits = T,
          frame.linewidth = 2,
          ticks.colour = "#808080",
          frame.linetype = 1,
          frame.colour = "#808080",
          ticks = T,
          even.steps = T,
          title = "Godina na\n100.000 < 75"
        )
      ) +
      theme_tufte() + theme(
        legend.position = c(.80, .85),
        text = element_text(size = 10,  family = "TT Arial"),
        legend.title = element_text(margin = margin(b = 10, unit = "pt"))
      ) +
      xlab(NULL) + ylab(NULL) + theme(
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()
      ) +
      geom_polygon(
        data = Kosovo,
        aes(x = long, y =  lat, group = group),
        color = "#808080",
        alpha = 0,
        linetype = 1
      ) +
      labs(caption = getMorans(map, motality_dataframe, variable)) +
      geom_map_pattern(
        map = foritfied_map,
        aes(map_id = id),
        pattern = ggplotdata$Pat ,
        pattern_alpha = 0.8,
        pattern_aspect_ratio = 1.75,
        pattern_density = 0.1,
        pattern_spacing	= 0.01,
        fill = NA,
        pattern_color = "#000000",
        pattern_fill = "#000000"
      )
    if (save_map) {
      ggsave(
        built_map,
        filename =  paste0(deparse(substitute(
          motality_dataframe
        )), ".png"),
        units = "mm",
        width = 210,
        height = 210,
        dpi = 600
      )
      knitr::plot_crop(x = paste0(deparse(substitute(
        motality_dataframe
      )), ".png"))
      
    }
    return(built_map)
    
  }


#Avoidable standardized YPLL map
  buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_Avoidable,
    variable = "YPLLi",
    paleta = "OrRd"
  )
#Amenable  standardized YPLL map
  buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_Amenable,
    variable = "YPLLi",
    paleta = "Reds"
  )
#Preventable standardized YPLL map
  buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_Preventable,
    variable = "YPLLi",
    paleta = "Oranges"
  )

#Overall standardized YPLL map 2020
  buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_TOTAL,
    variable = "YPLLi",
    paleta = "BuPu"
  )
  
  #Overall standardized YPLL map 2019
  buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_TOTAL_2017_2019,
    variable = "YPLLi",
    paleta = "BuPu"
  )
#Covid standardized YPLL map
  buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_Covid,
    variable = "YPLLi",
    paleta = "Purples"
  )
#NoNCovid standardized YPLL map
  buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_NoN_Covid,
    variable = "YPLLi",
    paleta = "Blues"
  )
  
   buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_Amenable,
    variable = "YPLLi",
    paleta = "Reds"
  )

```
```{r avoidable_trend, message=FALSE, warning=FALSE}
#Gender
popsr2020m <-
  pop %>% filter(god == 2020,!IDStarost %in% c("0", "V85"), IDTer == "RS", IDPol ==
                   1) %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by() %>% summarise(Pop =
                                                                                                                          sum(vrednost))
popsr2020f <-
  pop %>% filter(god == 2020,!IDStarost %in% c("0", "V85"), IDTer == "RS", IDPol ==
                   2) %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by() %>% summarise(Pop =
                                                                                                                          sum(vrednost))


sex_avoidable_years<- rbind(
  left_join(
    pop %>% filter(!IDStarost %in% c("0", "V85"), IDTer == "RS", god >= 2015, IDPol !=
                     0) %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by(Year =
                                                                                                            god, Sex = IDPol) %>% summarise(Pop = sum(vrednost)),
    umrli %>% filter(Starost < YPLL_Age,
                     Avoidable == 1,) %>%
      mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Sex = as.integer(Pol), Year =
                                                                       as.integer(Godina.materijala)) %>% summarise(YPLL = sum(YPLL))
  ) %>% mutate(Cause = "Avoidable"),
  left_join(
    pop %>% filter(!IDStarost %in% c("0", "V85"), IDTer == "RS", god >= 2015, IDPol !=
                     0) %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by(Year =
                                                                                                            god, Sex = IDPol) %>% summarise(Pop = sum(vrednost)),
    umrli %>% filter(
      Starost < YPLL_Age,
      Avoidable != 1,
      !Uzrok.smrti %in% c("U071", "U072")
    ) %>%
      mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Sex =
                                                                       as.integer(Pol), Year = as.integer(Godina.materijala)) %>% summarise(YPLL = sum(YPLL)) %>% mutate(Cause =
                                                                                                                                                                           "Other")
  ),
  left_join(
    pop %>% filter(!IDStarost %in% c("0", "V85"), IDTer == "RS", god == 2020, IDPol !=
                     0) %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by(Year =
                                                                                                            god, Sex = IDPol) %>% summarise(Pop = sum(vrednost)),
    umrli %>% filter(Starost < YPLL_Age,
                     Uzrok.smrti %in% c("U071", "U072")) %>%
      mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Sex =
                                                                       as.integer(Pol), Year = as.integer(Godina.materijala)) %>% summarise(YPLL = sum(YPLL)) %>% mutate(Cause =
                                                                                                                                                                           "SARS-CoV-2")
  )
) %>% mutate(YPLLR=YPLL/Pop*100000) 


sex_avoidable_years$Cause <- factor(sex_avoidable_years$Cause, levels =c("SARS-CoV-2", "Other","Avoidable") )
levels(sex_avoidable_years$Cause) <- c("SARS-CoV-2", "Ostali", "Moguće izbeći")

  
  barwidth = 0.35
  plot_sex_years <- ggplot() +
    geom_bar(
      data = sex_avoidable_years %>% filter(Sex == 2),
      position = "stack",
      stat = "identity",
      aes(x = Year, y = YPLLR, fill = Cause),
      width = barwidth
    ) +
    geom_bar(
      data = sex_avoidable_years %>% filter(Sex == 1),
      position = "stack",
      stat = "identity",
      aes(
        x = Year + barwidth + 0.1,
        y = YPLLR,
        fill = Cause
      ),
      width = barwidth
    ) +
    coord_flip() +
    scale_fill_manual(values = c("#d95f02", "#1b9e77", "#7570b3")) + # c( "#abdda4", "#2b83ba", "#d7191c"))+
    #guides(NULL)+
    theme_tufte() + #theme(legend.position = "none",text=element_text(size=10,  family="TT Arial"))+
    theme(
      text = element_text(size = 10,  family = "TT Arial"),
      axis.ticks.y = element_blank(),
      axis.text.y = element_text(
        hjust = -0.05,
        vjust = -5,
        face = "bold",
        angle = 90
      )
    ) +
    annotate(
      "text",
      x = c(2020, 2019, 2018, 2017, 2016, 2015),
      y = -150,
      label = "Ž",
      size = 3,
      color = "black"
    ) +
    annotate(
      "text",
      x = c(2020.5, 2019.5, 2018.5, 2017.5, 2016.5, 2015.5),
      y = -150,
      label = "M",
      size = 3,
      color = "black"
    ) +
    # scale_y_continuous(breaks = c(2000, 4000, 6000, 8000, 10000))+
    #annotate("text", x=2020, y=9150,label="COVID-19", size=2.5, angle = 90, color="black" )+
    #geom_hline(yintercept =c(2000, 4000, 6000, 8000, 10000),lwd=1, color="white")+
    ylab("YPLL na 100000 < 75") +
    xlab(NULL) +
    scale_y_continuous(breaks = seq(0, 12000, 2000)) +
    geom_hline(yintercept = seq(0, 12000, 2000), color = "white")
  
  #plot_sex_years
  
  
  ggsave(
    plot_sex_years,
    filename = "plot_sex_years.png",
    units = "mm",
    width = 175,
    height = 100,
    dpi = 600
  )
  #knitr::plot_crop(x = "plot_sex_years.png")
  

```
```{r median_indicators, message=FALSE, warning=FALSE}

umrli %>% filter(
    Godina.materijala == 2020,
    Starost < YPLL_Age,
    #Uzrok.smrti %in% c("U071", "U072")
) %>%
    mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Starost) %>% summarise(YPLL = sum(YPLL),Broj.pojava=sum(Broj.pojava)) %>% mutate(cumsum(YPLL), median(cumsum(Broj.pojava)))


disttest<-   umrli %>% filter(
    Godina.materijala == 2020,
    Starost < YPLL_Age) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Starost) %>% summarise(YPLL = sum(YPLL),Broj.pojava=sum(Broj.pojava) ) %>% group_by() %>% summarise(median(Broj.pojava))
  

x <- disttest %>% mutate(CYPLL=cumsum(YPLL), Ccount= cumsum(Broj.pojava))
x$Diff <- x$Ccount - max(x$Ccount)/2
x$Starost[which(x$Diff==min(abs(x$Diff)))]

findMedian <- function(x) {
Ccount= cumsum(x)
Diff <- Ccount - max(Ccount)/2
a <- 0:75
return(a[which(abs(Diff)==min(abs(Diff)))])
}

findMedian2 <- function(x) {
Ccount= cumsum(x)
Diff <- Ccount - rev(cumsum(rev(x)))
return(intersect())
return(data.frame(x=x,a=Ccount, b=rev(cumsum(rev(x))), c=Ccount-rev(cumsum(rev(x)))) %>% intersect(a,b))
a <- 0:75
return(a[which(abs(Diff)==min(abs(Diff)))])
}

FindMedian <- function(x) {
  age <- 0:75
  cs <- cumsum(x)
  mid <- findInterval(max(cs)/2, cs)+1
  ag <- age[mid]    
  f <- x[mid]       
  cs2 <- cs[mid - 1]          
  half <- max(cs)/2
  unname(ag + (half - cf2)/f )
}



```
```{r airpolution, message=FALSE, warning=FALSE}
library(raster)
library(rasterVis)
library(viridis)
library(profmem)
SerbiaPolution

```