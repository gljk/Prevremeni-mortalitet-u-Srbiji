---
title: "Prevremeni mortalitet u Srbiji"
author: "Marko Galjak"
date: "1/1/2022"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R kod korišćen za sređivanje podataka
U doktrorskoj diesrtaciji su korišćeni detaljni podaci o smrti u Srbiji za 6 godina od 2015. do 2020. godine
Datoteka za svaku godinu ima više od 80.000 redova podataka jer su podaci dati po polu, starosti, opštini i tačnom (četvroznačnom) uzroku smrti.
U pripremi podatka prvo ih objedinjujemo u jedan veliki dataframe i nakon toga svaki red svrtstavamo po kategorijama Međunarodne kategorizacije bolesti i prema tome da li su uzroci smrti oni koji se mogu izbeći, preventabilni ili predupredivi.

```{r data_consolidation, message=FALSE, warning=FALSE, fig.show='hide'}
require(tidyverse)
require(iterators)
require(openxlsx)
require(ggpattern)
require(spdep)
require(rgdal)
require(maptools)
require(ggthemes)
require(geojsonio)
require(ggpubr)
require(treemap)

#library(rasterVis)


#Učitavamo datoteke
mort_podaci_postoje <- file.exists("umrli15-20.xslx")
if (!mort_podaci_postoje) {
  umrli15 <- read.xlsx("RZS/Umrli_2015.xlsx")
  umrli16 <- read.xlsx("RZS/Umrli_2016.xlsx")
  umrli17 <- read.xlsx("RZS/Umrli_2017.xlsx")
  umrli19 <- read.xlsx("RZS/Umrli_2019.xlsx")
  umrli18 <- read.xlsx("RZS/Umrli_2018.xlsx")
  umrli20 <- read.xlsx("RZS/Umrli_2020.xlsx")
  
  colnames(umrli15)[2] <- "Opstina"
  colnames(umrli16)[2] <- "Opstina"
  colnames(umrli17)[2] <- "Opstina"
  colnames(umrli18)[2] <- "Opstina"
  colnames(umrli19)[2] <- "Opstina"
  colnames(umrli20)[2] <- "Opstina"
  
  umrli <- rbind(umrli15,
                 umrli16,
                 umrli17,
                 umrli18,
                 umrli19,
                 umrli20)
  
  rm(list = c(
    "umrli15",
    "umrli16",
    "umrli17",
    "umrli18",
    "umrli19",
    "umrli20"
  ))
  d <-
    as.data.frame(
      read.csv(
        file = "Mortalty Coding/Diagnosis2.txt",
        sep = "\t",
        quote = '""',
        header = F,
        stringsAsFactors = F,
        encoding = "UTF-8"
      )
    )
  d <- d[, 1:5]
  colnames(d) <- c("Chapter", "List", "Cause", "Title", "TilteSR")
  d <- d[d$List == 103, ]
  
  ch <-
    as.data.frame(
      read.csv(
        file = "Mortalty Coding/CodingChapters2.txt",
        sep = "\t",
        quote = '""',
        header = F,
        stringsAsFactors = F,
        encoding = "UTF-8"
      )
    )
  colnames(ch) <-
    c("Chapeter", "List", "Title", "TilteSR", "TitleSRCyr")
  ch <- ch[ch$List == 103, c(1, 3)]
  colnames(ch)[1] <- "Chapter"
  amenmort <- read_csv(file = "Mortalty Coding/amort.csv")
  amenmort$Cause <-
    gsub(pattern = "[.]",
         replacement = "",
         x = amenmort$Cause)
  
  ages <- list(
    `0-14` = 0:14,
    `0-19` = 0:19,
    `0-44` = 0:44,
    `0-74` = 0:74,
    `1-14` = 1:14,
    All = 1:150
  )
  
  MortClassifier <-
    function(dataset = NULL,
             cause = NULL,
             age = NULL,
             ages = NULL,
             i = NULL) {
      if (nrow(amenmort[amenmort$Cause == cause,]) != 0) {
        if (age %in% unlist(ages[as.character(amenmort[amenmort$Cause == cause, "AGE"])])) {
          return(cbind(data.frame(rn = i), amenmort[amenmort$Cause == cause, c(5, 6)]))
        }
        
      } else{
        if (nrow(amenmort[amenmort$Cause == substring(cause, 1, 3),]) != 0) {
          if (age %in% unlist(ages[as.character(amenmort[amenmort$Cause == substring(cause, 1, 3), "AGE"])])) {
            return(cbind(data.frame(rn = i), amenmort[amenmort$Cause == substring(cause, 1, 3), c(5, 6)]))
          }
        }
      }
      return(data.frame(
        rn = i,
        Amenable = 0,
        Preventable = 0
      ))
    }
  
  
  require(foreach)
  library(doParallel)
  
  cl <- makeCluster(11)
  registerDoParallel(cl)
  
  s2 <- data.frame(
    rn = 1:nrow(umrli),
    Amenable = NA,
    Preventable = NA
  )
  for (i in 1:nrow(umrli)) {
    s2[i, ] <-
      MortClassifier(
        dataset = amenmort,
        cause = umrli$Uzrok.smrti[i],
        age = umrli$Starost[i],
        ages = ages,
        i = i
      )
    
  }
  
  umrli <- cbind(umrli, s2)
  umrli$rn <- NULL
  umrli$Avoidable <- umrli$Preventable + umrli$Amenable
  umrli$Avoidable <- ifelse(umrli$Avoidable > 0, 1, 0)
  
  write.xlsx(umrli, "umrli15-20Avoidable.xlsx")
} else {
  umrli <- read.xlsx("umrli15-20Avoidable.xlsx")
}

#Sređivanje Grada Niša
opstine_nisa <-
  c("71285", "71307", "71315", "71323", "71331") #5 opština Grada Niša
umrli[umrli$Opstina %in% opstine_nisa, "Opstina"] <- "79022"

#Sređivanje Grada Novog Sada 

opstine_novog_sada <-
  c("80284", "80519")

umrli[umrli$Opstina %in% opstine_novog_sada, "Opstina"] <- "89010"


#Učitavanje podataka o proceni broja stanovnika sredini godine.

pop <- read.csv("RZS/Populacija.csv", sep = ";")

#Dodati podaci sa šifarnikom opština

opstine <- read.csv(file = "Serbia Map/opstine.csv")




```
##Definisanje funkcije za izračunavanje medijalne starosti izgubljenih godina potencijalnog života
```{r median_indicators, message=FALSE, warning=FALSE, fig.show='hide'}

FindMedian <- function(x) {
  intervals <- cbind(1:length(x)-1, 1:length(x))
  cf <- cumsum(x)
  if(max(cf)==0){
    return(NA)
  }
  Midrow <- findInterval(max(cf)/2, cf)+1
  L <- intervals[Midrow,1 ]     
  h <- diff(intervals[Midrow, ])
  f <- x[Midrow]  
  cf2 <- cf[Midrow - 1]       
  n_2 <- max(cf)/2            
  unname(L + (n_2 - cf2)/f * h)
}


```

## Dodavanje podatka o broju stanovnika i računanje pokazatelja YPLL
U prvomd delu se učitavaju podaci o populaciji koji se mogu preuzeti sa portala otvorenih podataka RZS.
Takođe je U ovom delu je dato računanje pokazatelja izgubljenih godina potencijalnog života.


```{r standardization, message=FALSE, warning=FALSE, fig.show='hide' }
#Učitavanja podataka o standardnoj evropskoj populaciji
standpop <- read.xlsx("StPopSingleYear.xlsx")
knitr::kable(standpop)

#svođenje standardne populacije na pondere (tako da zbir ukupne populacije bude 1)
standpop$stpop <- standpop$stpop / 1000000

#Kreiranje pondera za mlađe od 75 godina na osnovu standardne populacije koja ide do 85 godina.

standardpop75 <- standpop[1:75, ]
standardpop75$stpop <-(standpop$stpop[1:75] / sum(standpop$stpop[1:75]) * (sum(standpop$stpop) - sum(standpop$stpop[1:75]))) + standpop$stpop[1:75]
colnames(standardpop75)[1] <- "Starost"

#Kreiranje pondera za mlađe od 75 godina a starije od 30 na osnovu standardne populacije koja ide do 85 godina.
standardpop30_75 <-  standpop[31:75, ]
standardpop30_75$stpop <-(standpop$stpop[31:75] / sum(standpop$stpop[31:75]) * (sum(standpop$stpop) - sum(standpop$stpop[31:75]))) + standpop$stpop[31:75]
colnames(standardpop30_75)[1] <- "Starost"


#Definisanje referentnog godišta za računanje pokazatelja izgubljenih godina potencijalnog života
YPLL_Age <- 75

#Definisanje fukcije za računanje Standardizovanih godina izgubljenog života
stadnardize_ypll <- function(umrli=NULL, pop=NULL,standardpopulation=NULL,years=NULL, standard_age=NULL, causes=NULL ) {
standardized_mortality <- left_join(
    left_join(
        pop %>% filter(god %in% years , nPol == "Ukupno",!IDStarost %in% c("0", "V85")) %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost < YPLL_Age) %>% group_by(Opstina = IDTer, Starost) %>% summarise(Pop = sum(vrednost)), umrli %>% filter(Godina.materijala %in% years, Starost < YPLL_Age,if(!is.null(causes)){eval(parse(text = causes))} else {!Uzrok.smrti %in% c()}) %>% mutate(Broj.pojava = ifelse(is.na(Broj.pojava), 0, Broj.pojava)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Opstina, Starost) %>% summarise(YPLL = sum(YPLL))) %>% mutate(YPLL = ifelse(is.na(YPLL), 0, YPLL)) %>% mutate(YPLLR = YPLL /Pop * 100000), standardpopulation) %>% group_by(Opstina) %>% summarise( 
                                       Median_AGE_YPLL=FindMedian(YPLL),
                                       YPLLi = sum(YPLLR * stpop, na.rm = T),
                                       YPLLR = sum(YPLL) / sum(Pop) * 100000,
                                       YPLL = sum(YPLL),
                                       Pop = sum(Pop)
)
return(standardized_mortality)
}
stadnardize_ypll_republic <- function(umrli=NULL, pop=NULL,standardpopulation=NULL,years=NULL, standard_age=NULL, causes=NULL ) {

standardized_mortality_republic <- left_join(
    left_join(
        pop %>% filter(god %in% years , nPol == "Ukupno",!IDStarost %in% c("0", "V85")) %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost < YPLL_Age,IDTer %in% umrli$Opstina ) %>% group_by(Starost) %>% summarise(Pop = sum(vrednost)), umrli %>% filter(Godina.materijala %in% years, Starost < YPLL_Age,if(!is.null(causes)){eval(parse(text = causes))} else {!Uzrok.smrti %in% c()}) %>% mutate(Broj.pojava = ifelse(is.na(Broj.pojava), 0, Broj.pojava)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by( Starost) %>% summarise(YPLL = sum(YPLL), smrti=sum(Broj.pojava))) %>% mutate(YPLL = ifelse(is.na(YPLL), 0, YPLL)) %>% mutate(YPLLR = YPLL /Pop * 100000), standardpopulation) %>% group_by() %>% summarise( 
                                       Median_AGE_YPLL=FindMedian(YPLL),
                                       smrti= sum(smrti),
                                       YPLLi = sum(YPLLR * stpop, na.rm = T),
                                       YPLLR = sum(YPLL) / sum(Pop) * 100000,
                                       YPLL = sum(YPLL),
                                       Pop = sum(Pop)
)
return(standardized_mortality_republic)
}



#Računanje standardizovanog pokazatelja izgubljenih godina potencijalnog života umrlih od bolesti COVID-19
standardized_YPLL_Covid <- stadnardize_ypll(umrli, pop, standardpop75, c( 2020),YPLL_Age, causes='Uzrok.smrti %in% c("U071", "U072")' )



#Računanje standardizovanog pokazatelja izgubljenih godina potencijalnog života koji nisu umrli od bolesti COVID-19

standardized_YPLL_NoN_Covid <- stadnardize_ypll(umrli, pop, standardpop75, c( 2020),YPLL_Age, causes='!Uzrok.smrti %in% c("U071", "U072")' )


#Računanje standardizovanog pokazatelja izgubljenih godina potencijalnog života umrlih
 standardized_YPLL_TOTAL <- stadnardize_ypll(umrli, pop, standardpop75, c( 2020),YPLL_Age )
 
#Računanje standardizovanog pokazatelja izgubljenih godina potencijalnog života umrlih 2017-2019
standardized_YPLL_TOTAL_2017_2019 <- stadnardize_ypll(umrli, pop, standardpop75, c(2017,2018, 2019),YPLL_Age)

#Računanje standardizovanog pokazatelja izgubljenih godina potencijalnog života umrlih od uzroka smrti koji se mogu izbeći

standardized_YPLL_Avoidable_2017_2019 <- stadnardize_ypll(umrli, pop, standardpop75, c(2017,2018, 2019),YPLL_Age,causes='Avoidable==1')

#Računanje standardizovanog pokazatelja izgubljenih godina potencijalnog života umrlih od uzroka smrti koji se mogu izbeći

standardized_YPLL_Avoidable <- stadnardize_ypll(umrli, pop, standardpop75, c(2020),YPLL_Age,causes='Avoidable==1')

#Računanje standardizovanog pokazatelja izgubljenih godina potencijalnog života umrlih od uzroka smrti koji se mogu izbeći prevencijom

standardized_YPLL_Preventable <- stadnardize_ypll(umrli, pop, standardpop75, c(2020),YPLL_Age,causes='Preventable==1')
standardized_YPLL_Preventable_2017_2019  <- stadnardize_ypll(umrli, pop, standardpop75, c(2017,2018, 2019),YPLL_Age,causes='Preventable==1')

#Računanje standardizovanog pokazatelja izgubljenih godina potencijalnog života umrlih od uzroka smrti koji se mogu izbeći adekvatnom i pravovremenom zdravstvenom zaštitom

standardized_YPLL_Amenable <- stadnardize_ypll(umrli, pop, standardpop75, c(2020),YPLL_Age,causes='Amenable==1')
standardized_YPLL_Amenable_2017_2019  <- stadnardize_ypll(umrli, pop, standardpop75, c(2017,2018, 2019),YPLL_Age,causes='Amenable==1')


#Računanje standardizovanog pokazatelja izgubljenih godina potencijalnog života umrlih od smrti koje su se mogle izbeći 2017-2019
standardized_YPLL_Avoidable_2017_2019 <- stadnardize_ypll(umrli, pop, standardpop75, c(2017,2018, 2019),YPLL_Age,causes='Avoidable==1')

#Računanje standardizovanog pokazatelja izgubljenih godina potencijalnog života umrlih od smrti koje su se NISU mogle izbeći 2017-2019
standardized_YPLL_NoNAvoidable_2017_2019 <- stadnardize_ypll(umrli, pop, standardpop75, c(2017,2018, 2019),YPLL_Age,causes='Avoidable!=1')

#Računanje standardizovanog pokazatelja izgubljenih godina potencijalnog života umrlih od respiratornih bolesti 2017-2019
standardized_YPLL_respiratory_2017_2019 <- left_join(
    left_join(
        pop %>% filter(god %in% c(2017,2018, 2019) , nPol == "Ukupno",!IDStarost %in% c("0", "V85")) %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost < YPLL_Age) %>% group_by(Opstina = IDTer, Starost) %>% summarise(Pop = sum(vrednost)), umrli %>% filter(Godina.materijala %in% c(2017,2018, 2019), Starost < YPLL_Age,substring(Uzrok.smrti,1,3)=='J44') %>% mutate(Broj.pojava = ifelse(is.na(Broj.pojava), 0, Broj.pojava)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Opstina, Starost) %>% summarise(YPLL = sum(YPLL))) %>% mutate(YPLL = ifelse(is.na(YPLL), 0, YPLL)) %>% mutate(YPLLR = YPLL /Pop * 100000), standardpop75) %>% group_by(Opstina) %>% summarise( 
                                       Median_AGE_YPLL=FindMedian(YPLL),
                                       YPLLi = sum(YPLLR * stpop, na.rm = T),
                                       YPLLR = sum(YPLL) / sum(Pop) * 100000,
                                       YPLL = sum(YPLL),
                                       Pop = sum(Pop)
)


#Standardizovane godine izgubljenog života za celu Srbiju 2017-2019
stadnardize_ypll_republic(umrli, pop, standardpop75, c( 2017, 2018, 2019),YPLL_Age )


#TEST
standardized_YPLL_TOTAL_2017_2019 <- left_join(
  left_join(
    pop %>% filter(god %in% c(2017,2018, 2019) , nPol == "Ukupno",!IDStarost %in% c("0", "V85")) %>%
      mutate(Starost =as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by(Opstina = IDTer, Starost) %>% summarise(Pop = sum(vrednost)),
    umrli %>% filter(Godina.materijala %in% c(2017,2018, 2019) , Starost < YPLL_Age) %>%
      mutate(Broj.pojava = ifelse(is.na(Broj.pojava), 0, Broj.pojava)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Opstina, Starost) %>% summarise(YPLL = sum(YPLL))
  ) %>% mutate(YPLL = ifelse(is.na(YPLL), 0, YPLL)) %>% mutate(YPLLR = YPLL /Pop * 100000),
  standardpop75) %>% mutate(YPLLi = YPLL/Pop*stpop) %>%  group_by(Opstina) %>% summarise( Median_AGE_YPLL=FindMedian(YPLL),YPLLi = sum(YPLLi, na.rm = T)*100000, YPLLR = sum(YPLL) / sum(Pop) * 100000,
  YPLL = sum(YPLL),
  Pop = sum(Pop)
)

#Standardizovane godine izgubljenog života za celu Srbiju 2017-2019


```

##Tabela o generalnim informacijama o prevremenom mortalitetu


```{r opsti_prevremeni, message=FALSE, warning=FALSE, fig.show='hide' }

serbia_overall_premature <- left_join(
  umrli %>% filter(Starost < YPLL_Age) %>%
    mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Godina.materijala) %>% summarise(YPLL = sum(YPLL), `Umrli <75` = sum(Broj.pojava)),
  umrli %>% filter() %>% group_by(Godina.materijala) %>% summarise(Ukupno = sum(Broj.pojava))
) %>%  mutate(`Umrli <75 (%)` = round(`Umrli <75` / Ukupno * 100, 2))
knitr::kable(serbia_overall_premature)

```

```{r YPLL, message=FALSE, warning=FALSE, fig.show='hide', fig.show='hide'}

#Populacija Srbije
popsr2020 <-
  pop %>% filter(god == 2020,
                 nPol == "Ukupno",
                 !IDStarost %in% c("0", "V85"),
                 IDTer == "RS") %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost <
                                                                                         75) %>% group_by() %>% summarise(Pop = sum(vrednost))
popsr2019 <-
  pop %>% filter(god == 2019,
                 nPol == "Ukupno",
                 !IDStarost %in% c("0", "V85"),
                 IDTer == "RS") %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost <
                                                                                         75) %>% group_by() %>% summarise(Pop = sum(vrednost))
popsr2018 <-
  pop %>% filter(god == 2018,
                 nPol == "Ukupno",
                 !IDStarost %in% c("0", "V85"),
                 IDTer == "RS") %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost <
                                                                                         75) %>% group_by() %>% summarise(Pop = sum(vrednost))
popsr2017 <-
  pop %>% filter(god == 2017,
                 nPol == "Ukupno",
                 !IDStarost %in% c("0", "V85"),
                 IDTer == "RS") %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost <
                                                                                         75) %>% group_by() %>% summarise(Pop = sum(vrednost))

popsr2020m <-
  pop %>% filter(god == 2020,!IDStarost %in% c("0", "V85"), IDTer == "RS", IDPol ==
                   1) %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by() %>% summarise(Pop =
                                                                                                                          sum(vrednost))
popsr2020f <-
  pop %>% filter(god == 2020,!IDStarost %in% c("0", "V85"), IDTer == "RS", IDPol ==
                   2) %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by() %>% summarise(Pop =
                                                                                                                          sum(vrednost))



YPPL2020_C <- umrli %>% filter(Godina.materijala == 2020,
                               Starost < YPLL_Age,
                               Uzrok.smrti %in% c("U071", "U072")) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2020


YPPL2020_O <- umrli %>% filter(
  Godina.materijala == 2020,
  Starost < YPLL_Age,
  !Uzrok.smrti %in% c("U071", "U072"),
  Avoidable != 1
) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2020

YPPL2020_Avoidable <- umrli %>% filter(Godina.materijala == 2020,
                                       Starost < YPLL_Age, Avoidable == 1) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2020

umrli %>% filter(Godina.materijala == 2020,
                 Starost < YPLL_Age,) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2020


YPPL2019 <- umrli %>% filter(Godina.materijala == 2019,
                             Starost < YPLL_Age, Avoidable != 1) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2019

YPPL2019_Avoidable <- umrli %>% filter(Godina.materijala == 2019,
                                       Starost < YPLL_Age, Avoidable == 1) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2019


YPPL2018 <- umrli %>% filter(Godina.materijala == 2018,
                             Starost < YPLL_Age, Avoidable != 1) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2018

YPPL2018_Avoidable <- umrli %>% filter(Godina.materijala == 2018,
                                       Starost < YPLL_Age, Avoidable == 1) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2018


YPPL2017 <- umrli %>% filter(Godina.materijala == 2017,
                             Starost < YPLL_Age, Avoidable != 1) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2017

YPPL2017_Avoidable <- umrli %>% filter(Godina.materijala == 2017,
                                       Starost < YPLL_Age, Avoidable == 1) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000 /
  popsr2017




umrli %>% filter(Godina.materijala == 2020,
                 Uzrok.smrti %in% c("U071", "U072")) %>% filter((Pol == "1" &
                                                                   Starost < 65) | (Pol == "2" & Starost < 63)) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL))


covid_bar_plot <-
  data.frame(
    Year = c(2017, 2017, 2018, 2018, 2019, 2019, 2020, 2020, 2020),
    Type = c(
      "Other",
      "Avoidable",
      "Other",
      "Avoidable",
      "Other",
      "Avoidable",
      "SARS-CoV-2",
      "Avoidable",
      "Other"
    ),
    YPLL = unname(
      c(
        unlist(YPPL2017),
        unlist(YPPL2017_Avoidable),
        unlist(YPPL2018),
        unlist(YPPL2018_Avoidable),
        unlist(YPPL2019),
        unlist(YPPL2019_Avoidable),
        unlist(YPPL2020_C),
        unlist(YPPL2020_Avoidable),
        unlist(YPPL2020_O)
      )
    )
  )
covid_bar_plot$Type <-
  factor(covid_bar_plot$Type,
         levels = c("SARS-CoV-2", "Other", "Avoidable"))



fig2plos <-
  ggplot(covid_bar_plot , aes(x = Year, y = YPLL, fill = Type)) +
  geom_bar(position = "stack", stat = "identity") + coord_flip() +
  scale_fill_manual(values = c("#d95f02", "#1b9e77", "#7570b3")) + # c( "#abdda4", "#2b83ba", "#d7191c"))+
  #guides(NULL)+
  theme_tufte() + #theme(legend.position = "none",text=element_text(size=10,  family="TT Arial"))+
  theme(text = element_text(size = 10,  family = "TT Arial")) +
  scale_y_continuous(breaks = c(2000, 4000, 6000, 8000, 10000)) +
  #annotate("text", x=2020, y=9150,label="COVID-19", size=2.5, angle = 90, color="black" )+
  geom_hline(
    yintercept = c(2000, 4000, 6000, 8000, 10000),
    lwd = 1,
    color = "white"
  ) +
  ylab("Izgubljene godine potencijalnog života na 100.000 stanovnika") +
  xlab(NULL)
fig2plos

# ggsave(fig2plos,filename = "Figure2plos.svg", units = "mm", width = 175, height = 50)
# ggsave(fig2plos,filename = "figure2plos.png", units = "mm", width = 175, height = 50)
# ggsave(fig2plos,filename = "figure2plos.jpg", units = "mm", width = 175, height = 50, dpi = 600)
#

standardized_YPLL_Covid %>% group_by() %>% summarise(CV = sd(YPLLR) /
                                                       mean(YPLLR))

standardized_YPLL_NoN_Covid %>% group_by() %>% summarise(CV = sd(YPLLR) /
                                                           mean(YPLLR))

standardized_YPLL_TOTAL  %>% group_by() %>% summarise(CV = sd(YPLLR) /
                                                        mean(YPLLR))


```

```{r specificne_stope_smrtnosti_COVID,  message=FALSE, warning=FALSE, fig.show='hide'}


ss_starost_covid <- left_join(
umrli %>% filter(
  Godina.materijala == 2020,
  Starost < YPLL_Age,
  Uzrok.smrti %in% c("U071", "U072")
) %>% dplyr::mutate(Starost=car::recode(Starost,'c("85", "86", "87", "88", 
"89", "90", "91", "92", "93", "94", "95", "96", "97", "98", "99", 
"100", "101", "102", "103", "104", "105", "106", "107", "108", 
"109", "111", "112", "114", "999")="85"'))%>% group_by(Starost,Pol) %>% summarise(Smrti=sum(Broj.pojava)),
pop %>% filter(god==2020, IDTer=="RS",IDPol!=0, IDStarost!=0) %>% mutate(Starost=c(0:85,0:85) , Pol=as.character(IDPol))) %>% 
  mutate(`Specifična stopa smrtnosti`=Smrti/vrednost*1000, Pol=ifelse(Pol=="1","Muški", "Ženski")) %>% ggplot() + geom_line(aes(x=Starost, y=`Specifična stopa smrtnosti`, col=Pol),size=1) + theme_tufte() + scale_color_manual(values = c("#377eb8", "#e41a1c"))+ scale_x_continuous(breaks=scales::extended_breaks(n=20)) +ylab("Specifična stopa smrtnosti (‰)") + scale_y_continuous(breaks = c(10, 20, 30, 40, 50, 60),limits = c(0,60))

ss_starost_2020 <- left_join(
umrli %>% filter(
  Godina.materijala == 2020,
  Starost < YPLL_Age,
) %>% dplyr::mutate(Starost=car::recode(Starost,'c("85", "86", "87", "88", 
"89", "90", "91", "92", "93", "94", "95", "96", "97", "98", "99", 
"100", "101", "102", "103", "104", "105", "106", "107", "108", 
"109", "111", "112", "114", "999")="85"'))%>% group_by(Starost,Pol) %>% summarise(Smrti=sum(Broj.pojava)),
pop %>% filter(god==2020, IDTer=="RS",IDPol!=0, IDStarost!=0) %>% mutate(Starost=c(0:85,0:85) , Pol=as.character(IDPol))) %>% 
  mutate(`Specifična stopa smrtnosti`=Smrti/vrednost*1000, Pol=ifelse(Pol=="1","Muški", "Ženski")) %>% ggplot() + geom_line(aes(x=Starost, y=`Specifična stopa smrtnosti`, col=Pol),size=1) + theme_tufte() + scale_color_manual(values = c("#377eb8", "#e41a1c"))+ scale_x_continuous(breaks=scales::extended_breaks(n=20)) +ylab("Specifična stopa smrtnosti (‰)")+ scale_y_continuous(breaks = c(10, 20, 30, 40, 50, 60),limits = c(0,60))


ss_starost_2017_2019 <- left_join(
umrli %>% filter(
  Godina.materijala %in% c(2017,2018,2019),
  Starost < YPLL_Age,
 # Uzrok.smrti %in% c("U071", "U072")
) %>% dplyr::mutate(Starost=car::recode(Starost,'c("85", "86", "87", "88", 
"89", "90", "91", "92", "93", "94", "95", "96", "97", "98", "99","100", "101", "102", "103", "104", "105", "106", "107", "108","109", "111", "112", "114", "999")="85"'))%>% group_by(Starost,Pol) %>% summarise(Smrti=sum(Broj.pojava)),
pop %>% filter(god %in% c(2017,2018,2019) , IDTer=="RS",IDPol!=0, IDStarost!=0) %>% mutate(Starost=rep(c(0:85,0:85),3) , Pol=as.character(IDPol))%>% group_by(Pol, Starost) %>% summarise(vrednost=sum(vrednost))) %>% mutate(`Specifična stopa smrtnosti`=Smrti/vrednost*1000, Pol=ifelse(Pol=="1","Muški", "Ženski")) %>% ggplot() + geom_line(aes(x=Starost, y=`Specifična stopa smrtnosti`, col=Pol),size=1) + theme_tufte()+ scale_color_manual(values = c("#377eb8", "#e41a1c"))+ scale_x_continuous(breaks=scales::extended_breaks(n=20)) + ylab("Specifična stopa smrtnosti (‰)") + scale_y_continuous(breaks = c(10, 20, 30, 40, 50, 60),limits = c(0,60))

left_join(
  left_join(
umrli %>% filter(
  Godina.materijala == 2020,
  Starost < YPLL_Age,
) %>% dplyr::mutate(Starost=car::recode(Starost,'c("85", "86", "87", "88", 
"89", "90", "91", "92", "93", "94", "95", "96", "97", "98", "99", 
"100", "101", "102", "103", "104", "105", "106", "107", "108", 
"109", "111", "112", "114", "999")="85"'))%>% group_by(Starost,Pol) %>% summarise(Smrti=sum(Broj.pojava)),
pop %>% filter(god==2020, IDTer=="RS",IDPol!=0, IDStarost!=0) %>% mutate(Starost=c(0:85,0:85) , Pol=as.character(IDPol))) %>% 
  mutate(`Specifična stopa smrtnosti`=Smrti/vrednost*1000, Pol=ifelse(Pol=="1","Muški", "Ženski")) %>% select(Starost,Pol, SS20 = `Specifična stopa smrtnosti`) ,

left_join(
umrli %>% filter(
  Godina.materijala %in% c(2017,2018,2019),
  Starost < YPLL_Age,
 # Uzrok.smrti %in% c("U071", "U072")
) %>% dplyr::mutate(Starost=car::recode(Starost,'c("85", "86", "87", "88", 
"89", "90", "91", "92", "93", "94", "95", "96", "97", "98", "99","100", "101", "102", "103", "104", "105", "106", "107", "108","109", "111", "112", "114", "999")="85"'))%>% group_by(Starost,Pol) %>% summarise(Smrti=sum(Broj.pojava)),
pop %>% filter(god %in% c(2017,2018,2019) , IDTer=="RS",IDPol!=0, IDStarost!=0) %>% mutate(Starost=rep(c(0:85,0:85),3) , Pol=as.character(IDPol))%>% group_by(Pol, Starost) %>% summarise(vrednost=sum(vrednost))) %>% mutate(`Specifična stopa smrtnosti`=Smrti/vrednost*1000, Pol=ifelse(Pol=="1","Muški", "Ženski")) %>% select(Starost,Pol, SS1719 = `Specifična stopa smrtnosti`) 
) %>% mutate(VisakSS=((SS20-SS1719) /SS20) *100)



ypll_ages_2020 <- umrli %>% filter(
    Godina.materijala == 2020,
    Starost < YPLL_Age) %>%
    mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Starost, Pol) %>% summarise(YPLL = sum(YPLL),Broj.pojava=sum(Broj.pojava) ) %>%  mutate( Pol=ifelse(Pol=="1","Muški", "Ženski"))  
  
  
 ypll_ages_2020_plot <- ypll_ages_2020 %>%  ggplot() + geom_area(aes(x=Starost, y=YPLL, fill=Pol),size=1) + theme_tufte()+ scale_color_manual(values = c("#377eb8", "#e41a1c"))+ scale_x_continuous(breaks=scales::extended_breaks(n=20)) +scale_fill_manual(values = c("#377eb8", "#e41a1c"))+scale_y_continuous(breaks = c(5000, 10000, 15000, 20000, 25000),limits = c(0,25000)) + geom_vline(xintercept =ypll_ages_2020%>% group_by(Starost) %>% summarise(YPLL=sum(YPLL)) %>% pull(YPLL) %>% FindMedian(), col="#FFFFFF", size=1.5)+ geom_hline(yintercept = c(5000, 10000, 15000, 20000, 25000), col="#FFFFFF")
 
#Starosna distribucija izgubljenih godina potencijalnog života u Srbiji (trogodišnji prosek 2017-2019)

ypll_ages_1719<- umrli %>% filter(
  Godina.materijala %in% c(2017,2018,2019),
    Starost < 75) %>%
    mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Starost, Pol) %>% summarise(YPLL = sum(YPLL)/3,Broj.pojava=sum(Broj.pojava)/3 ) %>%  mutate( Pol=ifelse(Pol=="1","Muški", "Ženski")) 

ypll_ages_1719_plot<- ypll_ages_1719 %>% ggplot() + geom_area(aes(x=Starost, y=YPLL, fill=Pol),size=1) + theme_tufte()+ scale_color_manual(values = c("#377eb8", "#e41a1c"))+ scale_x_continuous(breaks=scales::extended_breaks(n=20)) +scale_fill_manual(values = c("#377eb8", "#e41a1c")) +scale_y_continuous(breaks = c(5000, 10000, 15000, 20000, 25000),limits = c(0,25000))+ geom_vline(xintercept =ypll_ages_1719%>% group_by(Starost) %>% summarise(YPLL=sum(YPLL)) %>% pull(YPLL) %>% FindMedian(), col="#FFFFFF", size=1.5)+ geom_hline(yintercept = c(5000, 10000, 15000, 20000, 25000), col="#FFFFFF")

#Starosna distribucija izgubljenih godina potencijalnog života u Srbiji smrti koje je bilo moguće izbeći (trogodišnji prosek 2017-2019)

ypll_ages_1719_avoidable<- umrli %>% filter(
  Godina.materijala %in% c(2017,2018,2019), Avoidable==1,
    Starost < 75) %>%
    mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Starost, Pol) %>% summarise(YPLL = sum(YPLL)/3,Broj.pojava=sum(Broj.pojava)/3 ) %>%  mutate( Pol=ifelse(Pol=="1","Muški", "Ženski")) 

ypll_ages_1719_avoidable_plot<- ypll_ages_1719_avoidable %>% ggplot() + geom_area(aes(x=Starost, y=YPLL, fill=Pol),size=1) + theme_tufte()+ scale_color_manual(values = c("#377eb8", "#e41a1c"))+ scale_x_continuous(breaks=scales::extended_breaks(n=20)) +scale_fill_manual(values = c("#377eb8", "#e41a1c")) +scale_y_continuous(breaks = c(5000, 10000, 15000, 20000, 25000),limits = c(0,25000))+ geom_vline(xintercept =ypll_ages_1719_avoidable%>% group_by(Starost) %>% summarise(YPLL=sum(YPLL)) %>% pull(YPLL) %>% FindMedian(), col="#FFFFFF", size=1.5)+ geom_hline(yintercept = c(5000, 10000, 15000, 20000, 25000), col="#FFFFFF")

#Starosna distribucija izgubljenih godina potencijalnog života u Srbiji smrti koje je bilo moguće izbeći prevencijom (trogodišnji prosek 2017-2019)

ypll_ages_1719_preventable<- umrli %>% filter(
  Godina.materijala %in% c(2017,2018,2019), Preventable==1,
    Starost < 75) %>%
    mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Starost, Pol) %>% summarise(YPLL = sum(YPLL)/3,Broj.pojava=sum(Broj.pojava)/3 ) %>%  mutate( Pol=ifelse(Pol=="1","Muški", "Ženski")) 

ypll_ages_1719_preventable_plot<- ypll_ages_1719_preventable %>% ggplot() + geom_area(aes(x=Starost, y=YPLL, fill=Pol),size=1) + theme_tufte()+ scale_color_manual(values = c("#377eb8", "#e41a1c"))+ scale_x_continuous(breaks=scales::extended_breaks(n=20)) +scale_fill_manual(values = c("#377eb8", "#e41a1c")) +scale_y_continuous(breaks = c(5000, 10000, 15000, 20000, 25000),limits = c(0,25000))+ geom_vline(xintercept =ypll_ages_1719_preventable%>% group_by(Starost) %>% summarise(YPLL=sum(YPLL)) %>% pull(YPLL) %>% FindMedian(), col="#FFFFFF", size=1.5)+ geom_hline(yintercept = c(5000, 10000, 15000, 20000, 25000), col="#FFFFFF")


ypll_ages_1719_amenable<- umrli %>% filter(
  Godina.materijala %in% c(2017,2018,2019), Amenable==1,
    Starost < 75) %>%
    mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Starost, Pol) %>% summarise(YPLL = sum(YPLL)/3,Broj.pojava=sum(Broj.pojava)/3 ) %>%  mutate( Pol=ifelse(Pol=="1","Muški", "Ženski")) 

ypll_ages_1719_amenable_plot<- ypll_ages_1719_amenable %>% ggplot() + geom_area(aes(x=Starost, y=YPLL, fill=Pol),size=1) + theme_tufte()+ scale_color_manual(values = c("#377eb8", "#e41a1c"))+ scale_x_continuous(breaks=scales::extended_breaks(n=20)) +scale_fill_manual(values = c("#377eb8", "#e41a1c")) +scale_y_continuous(breaks = c(5000, 10000, 15000, 20000, 25000),limits = c(0,25000))+ geom_vline(xintercept =ypll_ages_1719_amenable%>% group_by(Starost) %>% summarise(YPLL=sum(YPLL)) %>% pull(YPLL) %>% FindMedian(), col="#FFFFFF", size=1.5)+ geom_hline(yintercept = c(5000, 10000, 15000, 20000, 25000), col="#FFFFFF")



#U slučaju COVID-a treba da se postaramo da se uzmu u obzir i rana godišta za kojih nema smrti.

ypll_ages_2020_cov <-
  left_join(
    pop %>% filter(god == 2020, nPol != "Ukupno",!IDStarost %in% c("0", "V85")) %>% mutate(Starost =as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by(Starost, Pol=as.character(IDPol)) %>% summarise(Pop =sum(vrednost)),
  umrli %>% filter(
    Godina.materijala == 2020,
    Starost < YPLL_Age,
    Uzrok.smrti %in% c("U071", "U072")) %>% 
    mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Starost, Pol) %>% summarise(YPLL = sum(YPLL),Broj.pojava=sum(Broj.pojava) ) 
  )%>%  mutate( Pol=ifelse(Pol=="1","Muški", "Ženski"),Broj.pojava=ifelse(is.na(Broj.pojava),0, Broj.pojava), YPLL=ifelse(is.na(YPLL),0, YPLL) )
  
 ypll_ages_2020_cov_plot<- ypll_ages_2020_cov%>%  ggplot() + geom_area(aes(x=Starost, y=YPLL, fill=Pol),size=1) + theme_tufte()+ scale_color_manual(values = c("#377eb8", "#e41a1c"))+ scale_x_continuous(breaks=scales::extended_breaks(n=20)) +scale_fill_manual(values = c("#377eb8", "#e41a1c"))  +scale_y_continuous(breaks = c(5000, 10000, 15000, 20000, 25000),limits = c(0,25000))+geom_vline(xintercept =ypll_ages_2020_cov%>% group_by(Starost) %>% summarise(YPLL=sum(YPLL)) %>% pull(YPLL) %>% FindMedian(), col="#FFFFFF", size=1.5)+ geom_hline(yintercept = c(5000, 10000, 15000, 20000, 25000), col="#FFFFFF")



ggsave(ss_starost_covid,
        filename =  paste0(deparse(substitute(
          ss_starost_covid
        )), ".png"),
        units = "mm",
        width = 160,
        height = 80,
        dpi = 600
      )

ggsave(ss_starost_2017_2019,
        filename =  paste0(deparse(substitute(
          ss_starost_2017_2019
        )), ".png"),
        units = "mm",
        width = 160,
        height = 80,
        dpi = 600
      )

ggsave(ss_starost_2020,
        filename =  paste0(deparse(substitute(
          ss_starost_2020
        )), ".png"),
        units = "mm",
        width = 160,
        height = 80,
        dpi = 600
      )

ggsave(ypll_ages_1719_plot,
        filename =  paste0(deparse(substitute(
          ypll_ages_1719_plot
        )), ".png"),
        units = "mm",
        width = 160,
        height = 80,
        dpi = 600
      )
ggsave(ypll_ages_2020_plot,
        filename =  paste0(deparse(substitute(
          ypll_ages_2020_plot
        )), ".png"),
        units = "mm",
        width = 160,
        height = 80,
        dpi = 600
      )
ggsave(ypll_ages_2020_cov_plot,
        filename =  paste0(deparse(substitute(
          ypll_ages_2020_cov_plot
        )), ".png"),
        units = "mm",
        width = 160,
        height = 80,
        dpi = 600
      )

ggsave(ypll_ages_1719_avoidable_plot,
        filename =  paste0(deparse(substitute(
          ypll_ages_1719_avoidable_plot
        )), ".png"),
        units = "mm",
        width = 160,
        height = 80,
        dpi = 600
      )
ggsave(ypll_ages_1719_amenable_plot,
        filename =  paste0(deparse(substitute(
          ypll_ages_1719_amenable_plot
        )), ".png"),
        units = "mm",
        width = 160,
        height = 80,
        dpi = 600
      )

ggsave(ypll_ages_1719_preventable_plot,
        filename =  paste0(deparse(substitute(
          ypll_ages_1719_preventable_plot
        )), ".png"),
        units = "mm",
        width = 160,
        height = 80,
        dpi = 600
      )

```
##GIS Analiza
U ovom delu koristimo moranov globalni i lokalni indeks.

```{r GIS i kartiranje, message=FALSE, warning=FALSE, fig.show='hide'}



Serbia <- readShapePoly("SRdrMap/Serbia.shp")
Serbia@data$code[39] <- 71366
#Sređivanje grada Niša
Serbia@data$code[Serbia@data$code == 71285] = 79022
SRMAP <- fortify(Serbia, region = "code")
SRMAP$region <- SRMAP$id
Serbia@data$country[163] <- "SRB"
Kosovo <- geojson_read("Kosovo/Kosovo.geojson",  what = "sp")




spatial_processing <-
  function(map = NULL,
           foritfied_map = NULL,
           motality_dataframe = NULL,
           variable = NULL) {
    nb <- poly2nb(map, queen = TRUE)
    lw <- nb2listw(nb, style = "W", zero.policy = TRUE)
    
    x <-
      left_join(data.frame(Opstina = as.character(map@data$code)), motality_dataframe, by =
                  "Opstina")
    locmor <-
      localmoran(unname(unlist(c(x[, variable]))), lw, p.adjust.method = "bonferroni")
    locmor <- as.data.frame(locmor)
    return(left_join(
      foritfied_map,
      data.frame(
        Opstina = as.character(map@data$code),
        Ii = locmor$Ii,
        Pat = ifelse(locmor$`Pr(z != E(Ii))` < 0.1, "circle", "none")
      ),
      by = c("region" = "Opstina")
    ) %>% mutate(Pat = ifelse(Ii > 0 & Pat == "circle", "stripe", Pat)))
  }


getMorans <-
  function(map = NULL,
           mortality_dataframe = NULL,
           variable) {
    nb <- poly2nb(map, queen = TRUE)
    lw <- nb2listw(nb, style = "W", zero.policy = TRUE)
    x <-
      left_join(data.frame(Opstina = as.character(map@data$code)),
                mortality_dataframe,
                by = "Opstina")
    a <- moran.test(unname(unlist(c(x[, variable]))), lw)
    return(paste0(
      "Moran's I: ",
      round(a$estimate[1], 3),
      " (",
      scales::pvalue(a$p.value, accuracy = 0.0001, add_p = T),
      ")"
    ))
  }

probs <- c(0, 0.25, 0.5, 0.75, 1)

buildMap <-
  function(map = NULL,
           foritfied_map = NULL,
           motality_dataframe = NULL,
           variable = NULL,
           paleta = NULL,
           direction = 1,
           save_map = T,
           legend_title="Godina na\n100.000 < 75") {
        l2<- sort(motality_dataframe[,variable] %>% unlist %>% unname) %>% tail(2)

    ggplotdata <-
      spatial_processing(
        map = map,
        foritfied_map = foritfied_map,
        motality_dataframe = motality_dataframe,
        variable = variable
      )
        
    built_map <-
      ggplot(data = left_join(foritfied_map, motality_dataframe, by = c("region" =
                                                                          "Opstina")),
             aes(x = long, y = lat)) +
      geom_map(
        map = foritfied_map,
        aes(
          map_id = id,
          x = long,
          y = lat,
          fill = round(eval(parse(text=variable)), 0),
          group = group,
          label = region
        ),
        color = "#808080",
        na.rm = F
      ) +
      coord_map("mercator") +
      scale_fill_distiller(palette = paleta, direction = direction) +
      guides(
        fill = guide_colorsteps(
          show.limits = T,
          frame.linewidth = 2,
          ticks.colour = "#808080",
          frame.linetype = 1,
          frame.colour = "#808080",
          ticks = T,
          even.steps = T,
          title = legend_title
        )
      ) +
      theme_tufte() + theme(
        legend.position = c(.80, .85),
        text = element_text(size = 10,  family = "TT Arial"),
        legend.title = element_text(margin = margin(b = 10, unit = "pt"))
      ) +
      xlab(NULL) + ylab(NULL) + theme(
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()
      ) +
      geom_polygon(
        data = Kosovo,
        aes(x = long, y =  lat, group = group),
        color = "#808080",
        alpha = 0,
        linetype = 1
      ) +
      labs(caption = getMorans(map, motality_dataframe, variable)) +
      geom_map_pattern(
        map = foritfied_map,
        aes(map_id = id),
        pattern = ggplotdata$Pat ,
        pattern_alpha = 0.8,
        pattern_aspect_ratio = 1.75,
        pattern_density = 0.1,
        pattern_spacing	= 0.01,
        fill = NA,
        pattern_color = "#000000",
        pattern_fill = "#000000"
      )
    if (save_map) {
      ggsave(
        built_map,
        filename =  paste0(deparse(substitute(
          motality_dataframe
        )), ".png"),
        units = "mm",
        width = 210,
        height = 210,
        dpi = 600
      )
      knitr::plot_crop(x = paste0(deparse(substitute(
        motality_dataframe
      )), ".png"))
      
    }
    return(built_map)
    
  }


#Avoidable standardized YPLL map
  buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_Avoidable,
    variable = "YPLLi",
    paleta = "OrRd"
  )
#Amenable  standardized YPLL map
  buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_Amenable,
    variable = "YPLLi",
    paleta = "Reds"
  )

#Preventable standardized YPLL map
  buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_Preventable,
    variable = "YPLLi",
    paleta = "Oranges"
  )

#Overall standardized YPLL map 2020
  buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_TOTAL,
    variable = "YPLLi",
    paleta = "BuPu"
  )
  
  #Overall standardized YPLL map 2017-2019
     standardized_YPLL_TOTAL_2017_2019fixed<- standardized_YPLL_TOTAL_2017_2019 %>% mutate(YPLLi=ifelse(YPLLi>20796, 10289.861, YPLLi)) #izbacivanje Crne Trave

  buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_TOTAL_2017_2019fixed,
    variable = "YPLLi",
    paleta = "BuPu"
  )
#Covid standardized YPLL map
  buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_Covid,
    variable = "YPLLi",
    paleta = "Purples"
  )
#NoNCovid standardized YPLL map
  buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_NoN_Covid,
    variable = "YPLLi",
    paleta = "Blues"
  )
  
   buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_Amenable,
    variable = "YPLLi",
    paleta = "Reds"
  )
   
   
   #Avoidable standardized YPLL map 2017-2019
   
   standardized_YPLL_Avoidable_2017_2019fixed<- standardized_YPLL_Avoidable_2017_2019 %>% mutate(YPLLi=ifelse(YPLLi>13100, 7290.976, YPLLi)) #izbacivanje Crne Trave
  buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_Avoidable_2017_2019fixed,
    variable = "YPLLi",
    paleta = "OrRd"
  )
  
    #Amenable  standardized YPLL map 2017 -2019
     standardized_YPLL_Amenable_2017_2019fixed<- standardized_YPLL_Amenable_2017_2019 %>% mutate(YPLLi=ifelse(YPLLi>10917, 4005.083, YPLLi)) #izbacivanje Crne Trave

    buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_Amenable_2017_2019fixed,
    variable = "YPLLi",
    paleta = "OrRd"
  )
   #Prevetnable  standardized YPLL map 2017 -2019

    buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_Preventable_2017_2019,
    variable = "YPLLi",
    paleta = "Reds"
  )
  
  
buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe = standardized_YPLL_NoNAvoidable_2017_2019,
    variable = "YPLLi",
    paleta = "OrRd"
  )
  

   b<- standardized_YPLL_Avoidable_2017_2019[standardized_YPLL_Avoidable_2017_2019$Opstina!="71226",]
# Procena površine opština 
   
Serbia@data$area <- raster::area(Serbia)/1000000

#Dodavanje zarada
zaradaOpstina<- read.xlsx(xlsxFile = "Prosecne NETO zarade RSD.xlsx")

Serbia@data$wageGross <- left_join(Serbia@data,zaradaOpstina %>% filter(skrIndikator=="Просечне бруто зараде") %>% mutate(code=as.numeric(IDTer) ) %>%  select(code, Vrednost) %>%  group_by(code) %>% summarise(Vrednost=mean(as.numeric(Vrednost))))$Vrednost
Serbia@data$wageNet <- left_join(Serbia@data,zaradaOpstina %>% filter(skrIndikator=="Просечне нето зараде") %>% mutate(code=as.numeric(IDTer) ) %>%  select(code, Vrednost) %>%  group_by(code) %>% summarise(Vrednost=mean(as.numeric(Vrednost))))$Vrednost



#Računaje koefijenta korelacije izemđu gustine naseljenosti i nivoa YPLLi

cortestdata<- left_join(Serbia@data %>% mutate(code=as.character(code)), standardized_YPLL_TOTAL_2017_2019fixed, by=c("code"="Opstina"))

cor.test(cortestdata$Pop/cortestdata$area,cortestdata$YPLLi,method = "spearman")
cortestdata$density <- cortestdata$Pop/cortestdata$area

Serbia@data$YPLL17_19 <- cortestdata$YPLL/3
Serbia@data$MedianAgeYPLL17_19 <- cortestdata$Median_AGE_YPLL
Serbia@data$density <-  cortestdata$Pop/cortestdata$area
Serbia@data$YPLLi17_19 <- cortestdata$YPLLi

Serbia@data$pop <- cortestdata$Pop
Serbia@data$YPLLi20172019Total <- cortestdata$YPLLi20172019Total
Serbia@data$YPLLiSARS <- left_join(Serbia@data %>% mutate(code=as.character(code)), standardized_YPLL_Covid, by=c("code"="Opstina")) %>% pull(YPLLi)
Serbia@data$YPLLi20172019avoidable <- left_join(Serbia@data %>% mutate(code=as.character(code)), standardized_YPLL_Avoidable_2017_2019, by=c("code"="Opstina")) %>% pull(YPLLi)

Serbia@data$YPLLi20172019preventable <- left_join(Serbia@data %>% mutate(code=as.character(code)), standardized_YPLL_Preventable_2017_2019, by=c("code"="Opstina")) %>% pull(YPLLi)
Serbia@data$YPLLi20172019amenable <- left_join(Serbia@data %>% mutate(code=as.character(code)), standardized_YPLL_Amenable_2017_2019, by=c("code"="Opstina")) %>% pull(YPLLi)

Serbia@data$YPLLi20172019respiratory <- left_join(Serbia@data %>% mutate(code=as.character(code)), standardized_YPLL_respiratory_2017_2019, by=c("code"="Opstina")) %>% pull(YPLLi)


left_join(Serbia@data , opstine, by=c("code"="Code")) %>% group_by(Oblast) %>% summarize(YPLLi20172019avoidable=min(YPLLi20172019avoidable) )%>% left_join(Serbia@data) %>% View



cor.test(log(cortestdata$density),log(cortestdata$YPLLi),method = "spearman")

lm(data=cortestdata, formula = log(density)~log(YPLLi)) %>% summary



getscatterplot <- function(mortalitydataframe=NULL,map=NULL, x=NULL, y=NULL, cor=T) {
  cortestdata<- left_join(mortalitydataframe, Serbia@data %>% mutate(Opstina=as.character(code))) 
cortestdata$density <- cortestdata$Pop/cortestdata$area
scatterplottosave<-  cortestdata %>% ggplot(aes(x=eval(parse(text=x)),y=eval(parse(text=y)))) + geom_point() + theme_tufte() +stat_cor(p.digits = 2, aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~")))+xlab(x)+ylab(y)
  
  ggsave(scatterplottosave,
        filename =  paste0(paste(deparse(substitute(
          mortalitydataframe)),x,y, sep = "-"), ".png"), 
        units = "mm",
        width = 160,
        height = 80,
        dpi = 600
      )
  if(cor){
  print(cor.test(cortestdata$density, cortestdata$YPLLi, method ="spearman"))
  }

}
  

getscatterplot(mortalitydataframe = standardized_YPLL_TOTAL_2017_2019, map = Serbia,x= "log(density)",y= "log(YPLLi)")
getscatterplot(mortalitydataframe = standardized_YPLL_NoN_Covid, map = Serbia,x= "log(density)",y= "log(YPLLi)")
getscatterplot(mortalitydataframe = standardized_YPLL_TOTAL, map = Serbia,x= "log(density)",y= "log(YPLLi)")
getscatterplot(mortalitydataframe = standardized_YPLL_Covid, map = Serbia,x= "log(density)",y= "log(YPLLi)")
getscatterplot(mortalitydataframe = standardized_YPLL_Amenable, map = Serbia,x= "log(density)",y= "log(YPLLi)")
getscatterplot(mortalitydataframe = standardized_YPLL_Avoidable, map = Serbia,x= "log(density)",y= "log(YPLLi)")
getscatterplot(mortalitydataframe = standardized_YPLL_Preventable, map = Serbia,x= "log(density)",y= "log(YPLLi)")

getscatterplot(mortalitydataframe = standardized_YPLL_TOTAL_2017_2019, map = Serbia,x= "log(wageNet)",y= "log(YPLLi)")
getscatterplot(mortalitydataframe = standardized_YPLL_Avoidable, map = Serbia,x= "log(wageNet)",y= "log(YPLLi)")
getscatterplot(mortalitydataframe = standardized_YPLL_Amenable, map = Serbia,x= "log(wageNet)",y= "log(YPLLi)")
getscatterplot(mortalitydataframe = standardized_YPLL_Preventable, map = Serbia,x= "log(wageNet)",y= "log(YPLLi)")
getscatterplot(mortalitydataframe = standardized_YPLL_Covid, map = Serbia,x= "log(wageNet)",y= "log(YPLLi)")
getscatterplot(mortalitydataframe = standardized_YPLL_NoN_Covid, map = Serbia,x= "log(wageNet)",y= "log(YPLLi)")
getscatterplot(mortalitydataframe = standardized_YPLL_TOTAL, map = Serbia,x= "log(wageNet)",y= "log(YPLLi)")


```

```{r avoidable_trend, message=FALSE, warning=FALSE, fig.show='hide'}
#Gender
popsr2020m <-
  pop %>% filter(god == 2020,!IDStarost %in% c("0", "V85"), IDTer == "RS", IDPol ==
                   1) %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by() %>% summarise(Pop =
                                                                                                                          sum(vrednost))
popsr2020f <-
  pop %>% filter(god == 2020,!IDStarost %in% c("0", "V85"), IDTer == "RS", IDPol ==
                   2) %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by() %>% summarise(Pop =
                                                                                                                          sum(vrednost))


sex_avoidable_years<- rbind(
  left_join(
    pop %>% filter(!IDStarost %in% c("0", "V85"), IDTer == "RS", god >= 2015, IDPol !=
                     0) %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by(Year =
                                                                                                            god, Sex = IDPol) %>% summarise(Pop = sum(vrednost)),
    umrli %>% filter(Starost < YPLL_Age,
                     Avoidable == 1,) %>%
      mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Sex = as.integer(Pol), Year =
                                                                       as.integer(Godina.materijala)) %>% summarise(YPLL = sum(YPLL))
  ) %>% mutate(Cause = "Avoidable"),
  left_join(
    pop %>% filter(!IDStarost %in% c("0", "V85"), IDTer == "RS", god >= 2015, IDPol !=
                     0) %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by(Year =
                                                                                                            god, Sex = IDPol) %>% summarise(Pop = sum(vrednost)),
    umrli %>% filter(
      Starost < YPLL_Age,
      Avoidable != 1,
      !Uzrok.smrti %in% c("U071", "U072")
    ) %>%
      mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Sex =
                                                                       as.integer(Pol), Year = as.integer(Godina.materijala)) %>% summarise(YPLL = sum(YPLL)) %>% mutate(Cause =
                                                                                                                                                                           "Other")
  ),
  left_join(
    pop %>% filter(!IDStarost %in% c("0", "V85"), IDTer == "RS", god == 2020, IDPol !=
                     0) %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost < 75) %>% group_by(Year =
                                                                                                            god, Sex = IDPol) %>% summarise(Pop = sum(vrednost)),
    umrli %>% filter(Starost < YPLL_Age,
                     Uzrok.smrti %in% c("U071", "U072")) %>%
      mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Sex =
                                                                       as.integer(Pol), Year = as.integer(Godina.materijala)) %>% summarise(YPLL = sum(YPLL)) %>% mutate(Cause =
                                                                                                                                                                           "SARS-CoV-2")
  )
) %>% mutate(YPLLR=YPLL/Pop*100000) 


sex_avoidable_years$Cause <- factor(sex_avoidable_years$Cause, levels =c("SARS-CoV-2", "Other","Avoidable") )
levels(sex_avoidable_years$Cause) <- c("SARS-CoV-2", "Ostali", "Moguće izbeći")

  
  barwidth = 0.35
  plot_sex_years <- ggplot() +
    geom_bar(
      data = sex_avoidable_years %>% filter(Sex == 2),
      position = "stack",
      stat = "identity",
      aes(x = Year, y = YPLLR, fill = Cause),
      width = barwidth
    ) +
    geom_bar(
      data = sex_avoidable_years %>% filter(Sex == 1),
      position = "stack",
      stat = "identity",
      aes(
        x = Year + barwidth + 0.1,
        y = YPLLR,
        fill = Cause
      ),
      width = barwidth
    ) +
    coord_flip() +
    scale_fill_manual(values = c("#d95f02", "#1b9e77", "#7570b3")) + # c( "#abdda4", "#2b83ba", "#d7191c"))+
    #guides(NULL)+
    theme_tufte() + #theme(legend.position = "none",text=element_text(size=10,  family="TT Arial"))+
    theme(
      text = element_text(size = 10,  family = "TT Arial"),
      axis.ticks.y = element_blank(),
      axis.text.y = element_text(
        hjust = -0.05,
        vjust = -5,
        face = "bold",
        angle = 90
      )
    ) +
    annotate(
      "text",
      x = c(2020, 2019, 2018, 2017, 2016, 2015),
      y = -150,
      label = "Ž",
      size = 3,
      color = "black"
    ) +
    annotate(
      "text",
      x = c(2020.5, 2019.5, 2018.5, 2017.5, 2016.5, 2015.5),
      y = -150,
      label = "M",
      size = 3,
      color = "black"
    ) +
    # scale_y_continuous(breaks = c(2000, 4000, 6000, 8000, 10000))+
    #annotate("text", x=2020, y=9150,label="COVID-19", size=2.5, angle = 90, color="black" )+
    #geom_hline(yintercept =c(2000, 4000, 6000, 8000, 10000),lwd=1, color="white")+
    ylab("YPLL na 100000 < 75") +
    xlab(NULL) +
    scale_y_continuous(breaks = seq(0, 12000, 2000)) +
    geom_hline(yintercept = seq(0, 12000, 2000), color = "white")
  
  #plot_sex_years
  
  
  ggsave(
    plot_sex_years,
    filename = "plot_sex_years.png",
    units = "mm",
    width = 175,
    height = 100,
    dpi = 600
  )
  #knitr::plot_crop(x = "plot_sex_years.png")
  

```
```{r causes_and_treemaps, message=FALSE, warning=FALSE, fig.show='hide'}

#Učitavanje podataka o dijagnozama 

d <- as.data.frame(read.csv(file = "Mortalty Coding/Diagnosis2.txt",sep = "\t", quote = '""', header = F,stringsAsFactors = F, encoding = "UTF-8"))
d <- d[,1:5]
colnames(d) <- c("Chapter", "List", "Cause", "Title", "TilteSR")
d <- d[d$List==103,]


#Učitavanje podataka o kategorijama dijagnoza 


ch <- as.data.frame(read.csv(file = "Mortalty Coding/CodingChapters2.txt",sep = "\t", quote = '""', header = F, stringsAsFactors = F,encoding = "UTF-8"))
colnames(ch) <- c("Chapeter", "List", "Title", "TilteSR")
ch <- ch[ch$List==103,c(1,3)]
colnames(ch)[1] <- "Chapter"

#Definisanje funkcije koja priprema podatke o mortalitetu za treemap vizuelizaciju

prep_for_treemap <- name <- function(x, sr=F, size_col=NULL, category_col=NULL, title_col=NULL, negative=F){ 
  palet <-
    c(
      "9" = "#de2d26",
      "2" = "#636363",
      "20" = "#8DD3C7",
      "5" = "#FFFFB3",
      "6" = "#BEBADA",
      "3" = "#FB8072",
      "10" = "#80B1D3",
      "12" = "#FDB462",
      "1" = "#B3DE69",
      "4" = "#FCCDE5",
      "13" = "#D9D9D9",
      "14" = "#BC80BD",
      "18" = "#CCEBC5",
      "8" = "#FFED6F",
      "21" = "#7FC97F",
      "15" = "#BEAED4",
      "11" = "#FDC086",
      "16" = "#FFFF99",
      "22" = "#386CB0",
      "17" = "#F0027F",
      "19" = "#BF5B17",
      "7" = "#666666"
    )
lista <- vector()
tl <- vector
for(i in 1:22){
  lista[i] <- sum(x[x[,category_col]==i,size_col]) # (sum(x[x[,category_col])==i, size_col ]))
}
ccc <- as.data.frame(lista)
ccc[, 2] <- seq(1:22)
ccc <- ccc[order(-ccc$lista, ccc$V2) , ]
rl <- as.vector(ccc$V2)#ova lista su chapteri po zastupljenosti, tim redosledom se pojavljuju na treemapu

eval(parse(text = paste0("x <- x[with(x, order(",category_col,", ", title_col,")), ]"))) #da poredjam po kategorijama za loop ispod
j <- 0
repeat
{
  j <- j+1

  if(is.na(x[j,category_col])) next

  x[j,"Order"] <- which(rl==unname(unlist(x[j,category_col])))
  
  x[j,"Color"] <- unname(unlist(palet[ as.character(unname(unlist(x[j,category_col])))]))
  if(j==(nrow(x))){
    x <-  x %>% mutate(Percent= paste0(as.character(round(eval(parse(text = size_col))/sum(x[,size_col])*100, 2)), "%"))
    if(sr){
      x <-x %>% mutate(Percent=sub("\\.", ",", as.character.default(Percent)))
    }
    return(x)}
}

}

#Definisanje funkcije koja za kreiranje palete

palete_for_chapters <- function(Chapter) {
  palet <-
    c(
      "9" = "#de2d26",
      "2" = "#636363",
      "20" = "#8DD3C7",
      "5" = "#FFFFB3",
      "6" = "#BEBADA",
      "3" = "#FB8072",
      "10" = "#80B1D3",
      "12" = "#FDB462",
      "1" = "#B3DE69",
      "4" = "#FCCDE5",
      "13" = "#D9D9D9",
      "14" = "#BC80BD",
      "18" = "#CCEBC5",
      "8" = "#FFED6F",
      "21" = "#7FC97F",
      "15" = "#BEAED4",
      "11" = "#FDC086",
      "16" = "#FFFF99",
      "22" = "#386CB0",
      "17" = "#F0027F",
      "19" = "#BF5B17",
      "7" = "#666666"
    )
  palet_for_c <-  c()
  for(i in unique(Chapter)){
    palet_for_c <- c(palet_for_c, palet[i])
  }
  return(unname(unlist(palet_for_c)))
  
}

#Omotačka funkcija za lakšu produkciju treemap vizualizacije

create_treemap <- function(mortalitydataframe=NULL,diagnosisdataframe=NULL,sr=T,  size_col =NULL, category_col =NULL, title_col=NULL, aspect.ratio=1.5, width=5670, height=3780) {
  treefilename<- paste0(paste0(deparse(substitute(mortalitydataframe))),"treemap.png")
  print(treefilename)

  mortalitydataframe<- left_join(mortalitydataframe, diagnosisdataframe)
  treemapdata <-mortalitydataframe %>% prep_for_treemap(sr=sr, size_col =size_col,category_col = category_col , title_col = title_col)

  paleta<-  treemapdata %>% arrange(Order) %>% pull(Color) %>% unique
  png(filename = treefilename,width=width, height=height)
  treemap(dtf=treemapdata, index=c(title_col, size_col), vSize=size_col, vColor = "Order", type = "manual", 
          palette=paleta,
          title = "",
          range=c(1,length(paleta)),
          fontfamily.labels=c("sans","sans"),
          fontsize.labels=c(6,2),
          aspRatio=aspect.ratio,
          align.labels=list(c("center", "center"), c("right", "bottom")),
          overlap.labels=0.1,
          bg.labels=0,
          lowerbound.cex.labels=0.1,
          border.lwds=0.5,
          inflate.labels = T,
          border.col = "white",
          algorithm= "pivotSize",
          sortID= "color",
          position.legend	="none",
          #format.legend= "Chapter"
  )
  dev.off()
  
}


#Pripremanje mortalitetnih podatak 
umrli_YPLL_TOTAL_2017_2019<- umrli %>% filter(
  Godina.materijala %in% c(2017:2019),
  Starost < YPLL_Age
) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava, Cause=substring(Uzrok.smrti,1,3)) %>% group_by(Cause) %>% summarise(YPLL = round(sum(YPLL)/3,1))
umrli_YPLL_TOTAL_2017_2019$Cause <- factor(umrli_YPLL_TOTAL_2017_2019$Cause)
create_treemap(mortalitydataframe = umrli_YPLL_TOTAL_2017_2019,diagnosisdataframe = d, sr=T, size_col ="YPLL",category_col = "Chapter", title_col = "TilteSR")


umrli_YPLL_TOTAL_2017_2019m<- umrli %>% filter(
  Pol=="1",
  Godina.materijala %in% c(2017:2019),
  Starost < YPLL_Age,
) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava, Cause=substring(Uzrok.smrti,1,3)) %>% group_by(Cause) %>% summarise(YPLL = round(sum(YPLL)/3,1))
umrli_YPLL_TOTAL_2017_2019m$Cause <- factor(umrli_YPLL_TOTAL_2017_2019m$Cause)

umrli_YPLL_TOTAL_2017_2019f<- umrli %>% filter(
  Pol=="2",
  Godina.materijala %in% c(2017:2019),
  Starost < YPLL_Age,
) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava, Cause=substring(Uzrok.smrti,1,3)) %>% group_by(Cause) %>% summarise(YPLL = round(sum(YPLL)/3,1))
umrli_YPLL_TOTAL_2017_2019f$Cause <- factor(umrli_YPLL_TOTAL_2017_2019f$Cause)

create_treemap(mortalitydataframe = umrli_YPLL_TOTAL_2017_2019m,diagnosisdataframe = d, sr=T, size_col ="YPLL",category_col = "Chapter", title_col = "TilteSR",aspect.ratio = 1.5, height = 2520, width = 3780)
create_treemap(mortalitydataframe = umrli_YPLL_TOTAL_2017_2019f,diagnosisdataframe = d, sr=T, size_col ="YPLL",category_col = "Chapter", title_col = "TilteSR",aspect.ratio = 0.84, height =2520, width = 2117)


#Treemap prevremenog mortalitea koji se može izbeći
umrli_YPLL_Avoidable_2017_2019<- umrli %>% filter(
  Godina.materijala %in% c(2017:2019),Avoidable==1,
  Starost < YPLL_Age
) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava, Cause=substring(Uzrok.smrti,1,3)) %>% group_by(Cause) %>% summarise(YPLL = round(sum(YPLL)/3,1))
umrli_YPLL_Avoidable_2017_2019$Cause <- factor(umrli_YPLL_Avoidable_2017_2019$Cause)
create_treemap(mortalitydataframe = umrli_YPLL_Avoidable_2017_2019,diagnosisdataframe = d, sr=T, size_col ="YPLL",category_col = "Chapter", title_col = "TilteSR")
#Treemap prevremenog mortalitea koji se može izbeći

umrli_YPLL_Preventable_2017_2019<- umrli %>% filter(
  Godina.materijala %in% c(2017:2019),Preventable==1,
  Starost < YPLL_Age
) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava, Cause=substring(Uzrok.smrti,1,3)) %>% group_by(Cause) %>% summarise(YPLL = round(sum(YPLL)/3,1))
umrli_YPLL_Preventable_2017_2019$Cause <- factor(umrli_YPLL_Preventable_2017_2019$Cause)
create_treemap(mortalitydataframe = umrli_YPLL_Preventable_2017_2019,diagnosisdataframe = d, sr=T, size_col ="YPLL",category_col = "Chapter", title_col = "TilteSR")


#Treemap prevremenog mortalitea koji se može izbeći
umrli_YPLL_Amenable_2017_2019<- umrli %>% filter(
  Godina.materijala %in% c(2017:2019),Amenable==1,
  Starost < YPLL_Age
) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava, Cause=substring(Uzrok.smrti,1,3)) %>% group_by(Cause) %>% summarise(YPLL = round(sum(YPLL)/3,1))
umrli_YPLL_Amenable_2017_2019$Cause <- factor(umrli_YPLL_Amenable_2017_2019$Cause)
create_treemap(mortalitydataframe = umrli_YPLL_Amenable_2017_2019,diagnosisdataframe = d, sr=T, size_col ="YPLL",category_col = "Chapter", title_col = "TilteSR")


d<- rbind(d,c(22, 103, "U07", "SARS-CoV-2", "SARS-CoV-2"))

umrli_YPLL_2020<- umrli %>% filter(
  Godina.materijala %in% c(2020),
  Starost < YPLL_Age
) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava, Cause=substring(Uzrok.smrti,1,3)) %>% group_by(Cause) %>% summarise(YPLL = round(sum(YPLL),1))

umrli_YPLL_2020$Cause <- factor(umrli_YPLL_2020$Cause)

create_treemap(mortalitydataframe = umrli_YPLL_2020,diagnosisdataframe = d, sr=T, size_col ="YPLL",category_col = "Chapter", title_col = "TilteSR")






```
```{r airpolution, message=FALSE, warning=FALSE, fig.show='hide'}

require(sp)

#GIS podaci o PM2.5 zagađenju na celoj Zemlji, preuzeto sa https://sedac.ciesin.columbia.edu/data/set/sdei-global-annual-gwr-pm2-5-modis-misr-seawifs-aod

world_pm25_postoje <- file.exists("SerbiaPolution")
if(!world_pm25_postoje){
world <- raster::stack("AeroZag/pm25 geotiff global 2016/gwr_pm25_2016.tif")
cr<-crop(world, Serbia)
fr<-rasterize(Serbia, cr)
SerbiaPolution<-mask(x=cr, mask=fr)
}else{
SerbiaPolution<- readRDS(file = "SerbiaPolution")
}

#Gis podaci o distribuciji stanovništva su preuzeti sa https://sedac.ciesin.columbia.edu/data/collection/gpw-v4
world_urban2<- raster::stack("AeroZag/gpw-v4-population-density-rev11_2020_30_sec_tif/gpw_v4_population_density_rev11_2020_30_sec.tif")

cr<-raster:: crop(world_urban2, Serbia)
fr<-raster::rasterize(Serbia, cr)
urban<-raster::mask(x=cr, mask=fr)

#Promena rezolucije, tako da se poklapa sa podacima o zagađenju
urban<- raster::resample(urban,SerbiaPolution, method='bilinear')


#Ponderisanje prosečnog zagađenja i računanje po opštini
WeigthedPolution <- SerbiaPolution
WeigthedPolution@data@values= SerbiaPolution@data@values * urban@data@values 
WeigthedPolution_stats<- raster::extract(WeigthedPolution, Serbia)
WeigthedPolution_stats<- lapply(WeigthedPolution_stats, FUN=sum,na.rm=TRUE)
urban_stats<- raster::extract(urban, Serbia)
urban_stats<- lapply(urban_stats, FUN=sum,na.rm=TRUE)

Serbia@data$pm25 <- WeigthedPolution_stats %>% unlist / urban_stats %>% unlist

m_d_f_p<- Serbia@data %>% mutate(Opstina=as.character(code)) %>% dplyr::select(Opstina, pm25)
                                 
  buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe =m_d_f_p,
    variable = "pm25",
    paleta = "Greys",
    legend_title = "PM2.5 na mg/m3"
  )
  
Serbia@data<- cbind(Serbia@data , left_join(m_d_f_p,
 umrli %>% filter(Godina.materijala %in% c(2017:2019),
                 Starost>30,
                Starost < YPLL_Age) %>%
    mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Opstina) %>% summarise(YPLL=sum(YPLL)/3, Broj=sum(Broj.pojava)/3) %>% mutate(code=as.numeric(Opstina))) %>% mutate(YPLLpm2.5=(pm25/10*6.2*YPLL)/100, BrojPM25=(pm25/10*6.2*Broj)/100) %>%  select(YPLLpm2.5, BrojPM25))


standardized_mortality_pm25 <- 
  left_join(
  left_join(
    left_join(
        pop %>% filter(god %in%  c(2017:2019) , nPol == "Ukupno",!IDStarost %in% c("0", "V85")) %>% mutate(Starost = as.integer(IDStarost)) %>% filter(Starost < YPLL_Age, Starost>30) %>% group_by(Opstina = IDTer, Starost) %>% summarise(Pop = sum(vrednost)),
        umrli %>% filter(Godina.materijala %in% c(2017:2019),
                         Starost < YPLL_Age,Starost>30 ) %>% 
          mutate(Broj.pojava = ifelse(is.na(Broj.pojava), 0, Broj.pojava)) %>% 
          mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>%
          group_by(Opstina, Starost) %>% summarise(YPLL = sum(YPLL), Broj.pojava = sum(Broj.pojava, na.rm = T))) %>% mutate(YPLL = ifelse(is.na(YPLL), 0, YPLL)) %>% mutate(YPLLR = (YPLL) /Pop * 100000), standardpop30_75),m_d_f_p) %>% 
  group_by(Opstina) %>% summarise(
    Median_AGE_YPLL=FindMedian(YPLL),
    YPLLi = sum(((pm25/10*6.2)/100)*YPLLR * stpop, na.rm = T),
    YPLLR = sum(((pm25/10*6.2)/100*YPLL) / sum(Pop) * 100000,
    Pop = sum(Pop)/3),
    YPLL = sum(((pm25/10*6.2)/100)*YPLL)/3,
    Broj.pojava = sum(((pm25/10*6.2)/100)*Broj.pojava, na.rm = T)/3,
    )
                                       
 
  buildMap(
    map = Serbia,
    foritfied_map = SRMAP,
    motality_dataframe =standardized_mortality_pm25,
    variable = "YPLLi",
    paleta = "Greens",
    legend_title = "Godina na\n100.000 30-75"
  )
 
  Serbia@data$YPLLi17_19_PM25 <- left_join(Serbia@data %>% mutate(Opstina=as.character(code)), standardized_mortality_pm25)$YPLLi


# Serbia@data$pm25 <- WeigthedPolution_stats %>% unlist / urban_stats %>% unlist
# 
# 
# Serbia@data$pm25
# 

# 
# lm(Zagadjenje, formula = pm25~log(wageNet)+log(pop)) 
# 
# lm(Zagadjenje, formula = YPLLiSARS~wageNet) %>% summary()
# 
# Zagadjenje$reziduali<- lm(Zagadjenje, formula = pm25~log(wageNet)+log(pop)) %>% residuals() %>% unlist %>% unname
# 
# 
# 
# lm(Serbia@data, formula = YPLLi20172019respiratory~pm25)
# 
# 
# WeigthedPolution_stats<- raster::extract(WeigthedPolution, unionSpatialPolygons(Serbia,IDs =Serbia@data$country ))
# WeigthedPolution_stats<- lapply(WeigthedPolution_stats, FUN=sum,na.rm=TRUE)
# urban_stats<- raster::extract(urban, unionSpatialPolygons(Serbia,IDs =Serbia@data$country ))
# urban_stats<- lapply(urban_stats, FUN=sum,na.rm=TRUE)
# WeigthedPolution_stats %>% unlist / urban_stats %>% unlist
# 
 Causes_AirPolution<- c( paste0("I60",0:9 ),paste0("I61",0:9 ),paste0("I62",0:9 ), paste0("I63",0:9 ),paste0("I64",0:9 ), paste0("I65",0:9 ), paste0("I66",0:9 ), paste0("I67",0:9 ), paste0("I69",0:3 ),paste0("I20",0:9 ),paste0("I21",0:9 ), paste0("I22",0:9 ), paste0("I23",0:9 ), paste0("I24",0:9 ),paste0("I25",0:9 ),paste0("J40",0:9 ),paste0("J41",0:9 ),paste0("J42",0:9 ),paste0("J43",0:9 ),paste0("J44",0:9 ) ,paste0("J47",0:9 ),paste0("C33",0:9 ),paste0("C34",0:9 ), paste0("D02",1:2 ), "D381" )
# 

standardized_YPLL_aeropolution<- stadnardize_ypll(umrli, pop, standardpop75, c(2017:2019),YPLL_Age,causes='substring(Uzrok.smrti,1,3) %in% c("J40", "J41", "J42", "J43", "J44")') 

  Serbia@data$YPLLi17_19_aero <-   left_join(Serbia@data %>% mutate(Opstina=as.character(code)), standardized_YPLL_aeropolution)$YPLLi
 





```
```{r correlation, message=FALSE, warning=FALSE, fig.show='hide'}

# cordata<- Serbia@data %>% select('YPLLi 2017-2019'= YPLLi17_19,'Me Starost YPLL 2017-2019'= MedianAgeYPLL17_19, 'Izbežni YPLLi 2017-2019'=YPLLi20172019avoidable,'Preventabilni YPLLi 2017-2019'= YPLLi20172019preventable, 'Predupredivi YPLLi 2017-2019'=YPLLi20172019amenable, 'SARS-CoV-2 YPLLi 2020'=YPLLiSARS, 'PM25 YPLLi 2017-2019'= YPLLi17_19_PM25, 'Neto plata'= wageNet ,'Gustina naseljenosti'=density, 'PM2.5'= pm25 ) 
# 
# cormat<-cordata %>% cor(method = "spearman")
# pmat<- cordata %>% rstatix::cor_pmat(,
#                                      method = "spearman")
# pmat$rowname <- NULL
# rownames(pmat) <- pmat %>% colnames()
# 
# 
#   get_lower_tri<-function(cormat){
#     cormat[upper.tri(cormat)] <- NA
#     return(cormat)
#   }
#   # Get upper triangle of the correlation matrix
#   get_upper_tri <- function(cormat){
#     cormat[lower.tri(cormat)]<- NA
#     return(cormat)
#   }
# 
# #cormat <- reorder_cormat(cormat)
# upper_tri <- get_upper_tri(cormat)
# upper_tri_pmat <- get_upper_tri(pmat)
# # Melt the correlation matrix
# melted_cormat <- reshape2::melt(upper_tri, na.rm = TRUE)
# melted_pmat <- reshape2::melt(upper_tri_pmat, na.rm = TRUE)
# 
# melted_cormat$pvalue <- melted_pmat$value
# # Create a ggheatmap
# ggheatmap <- ggplot(melted_cormat, aes(Var2, Var1, fill = value))+
#  geom_tile(color = "white")+
#  scale_fill_gradient2(low = "#1f78b4", high = "#e31a1c", mid = "white", 
#    midpoint = 0, limit = c(-1,1), space = "Lab", 
#     name="Spirmanov koeficijent\nkorelacije") +
#   theme_tufte()+ # minimal theme
#  theme(axis.text.x = element_text(angle = 45, vjust = 1, 
#     size = 12, hjust = 1))+
#  coord_fixed()
# # Print the heatmap
# 
# final_cormat_heatmap<- ggheatmap + 
# geom_text(aes(Var2, Var1, label = gsub(pattern = '[.]', replacement = ',',x = round(value,2)),alpha=ifelse(pvalue<0.05, 1,0)), color = "#000000",guide="none", size = 4) +
# theme(
#   axis.title.x = element_blank(),
#   axis.title.y = element_blank(),
#   panel.grid.major = element_blank(),
#   panel.border = element_blank(),
#   panel.background = element_blank(),
#   axis.ticks = element_blank(),
#   legend.justification = c(1, 0),
#   legend.position = c(0.6, 0.7),
#   legend.direction = "horizontal")+
#   guides(fill = guide_colorbar(barwidth = 7, barheight = 1,
#                 title.position = "top", title.hjust = 0.5))+ scale_alpha(guide = 'none')
# 
# ggsave(final_cormat_heatmap,
#         filename =  paste0(deparse(substitute(
#           final_cormat_heatmap
#         )), ".png"),
#         units = "mm",
#         width = 160,
#         height = 160,
#         dpi = 600
#       )


#lm(data=Serbia@data, formula = YPLLi17_19~log(density)+pm25:log(density)) %>% summary

#lm(data=Serbia@data, formula = YPLLiSARS~YPLLi17_19+pm25+log(density)+pm25:YPLLi17_19+log(density):YPLLi17_19) %>% plot

# partykit::lmtree(data=Serbia@data, formula = YPLLi17_19~ pm25|wageNet|density) %>% summary
# 
# a <- glm(YPLLi17_19~pm25, data = Serbia@data)
# b<- glmulti::glmulti(a)
# glmulti::glmulti(y="YPLLiSARS",xr=c("YPLLi17_19", "pm25", "log(wageNet)", "log(density)"),data=Serbia@data)
# 
# require(mgcv)
# gam(data=Serbia@data, formula = YPLLi17_19~pm25+s(wageNet)) %>% plot
# 
#        lm(data=Serbia@data, formula = YPLLi17_19~pm25) %>% summary

```

```{r ekonomska_cena, message=FALSE, warning=FALSE}



ypll_prod <- function(mdf, years, causes) {
  

    mdf %>% filter(
      Godina.materijala %in% years,
      if(!is.null(causes)){eval(parse(text = causes))} else {!Uzrok.smrti %in% c()}
    ) %>% filter((Pol=="2" & Starost<15)) %>% group_by() %>%  summarise(sum(Broj.pojava))*(63-15)+
    mdf %>% filter(
      Godina.materijala %in% years,
     if(!is.null(causes)){eval(parse(text = causes))} else {!Uzrok.smrti %in% c()}
    ) %>% filter((Pol=="1" & Starost<15)) %>% group_by() %>%  summarise(sum(Broj.pojava))*(65-15)+
    

    mdf %>% filter(
      Godina.materijala  %in% years,
     if(!is.null(causes)){eval(parse(text = causes))} else {!Uzrok.smrti %in% c()}
    ) %>% filter((Pol=="1" & Starost>=15 & Starost<65)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL))+
    
    mdf %>% filter(
      Godina.materijala  %in% years,
      if(!is.null(causes)){eval(parse(text = causes))} else {!Uzrok.smrti %in% c()}
    ) %>% filter((Pol=="2" & Starost>=15 & Starost<63)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL))
}

    #Ekonomska cena SARS-CoV-2    
    
ypll_prod( umrli, c(2015), "Avoidable==1")+
ypll_prod( umrli, c(2016), "Avoidable==1")+
ypll_prod( umrli, c(2017), "Avoidable==1")+
ypll_prod( umrli, c(2018), "Avoidable==1")+
ypll_prod( umrli, c(2019), "Avoidable==1")+
ypll_prod( umrli, c(2020), "Avoidable==1")


ypll_prod( umrli, c(2015), "Starost>30")
ypll_prod( umrli, c(2016), "Starost>30")
ypll_prod( umrli, c(2017), "Starost>30")
ypll_prod( umrli, c(2018), "Starost>30")
ypll_prod( umrli, c(2019), "Starost>30")
ypll_prod( umrli, c(2020), "Starost>30")

```


