---
title: "Prevremeni mortalitet u Srbiji"
author: "Marko Galjak"
date: "1/1/2022"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R kod korišćen za sređivanje podataka
U doktrorskoj diesrtaciji su korišćeni detaljni podaci o smrti u Srbiji za 6 godina od 2015. do 2020. godine
Datoteka za svaku godinu ima više od 80.000 redova podataka jer su podaci dati po polu, starosti, opštini i tačnom (četvroznačnom) uzroku smrti.
U pripremi podatka prvo ih objedinjujemo u jedan veliki dataframe i nakon toga svaki red svrtstavamo po kategorijama Međunarodne kategorizacije bolesti i prema tome da li su uzroci smrti oni koji se mogu izbeći, preventabilni ili predupredivi.

```{r data_consolidation}
require(tidyverse)
require(iterators)
require(openxlsx)
require(ggpattern)
library(spdep)
require(rgdal)
require(maptools)
require(ggthemes)

#Učitavamo datoteke 
mort_podaci_postoje <- file.exists("umrli15-20.xslx")
if(!mort_podaci_postoje){
umrli15<- read.xlsx("RZS/Umrli_2015.xlsx")
umrli16<- read.xlsx("RZS/Umrli_2016.xlsx")
umrli17<- read.xlsx("RZS/Umrli_2017.xlsx")
umrli19<- read.xlsx("RZS/Umrli_2019.xlsx")
umrli18<- read.xlsx("RZS/Umrli_2018.xlsx")
umrli20<- read.xlsx("RZS/Umrli_2020.xlsx")

colnames(umrli15)[2] <- "Opstina"
colnames(umrli16)[2] <- "Opstina"
colnames(umrli17)[2] <- "Opstina"
colnames(umrli18)[2] <- "Opstina"
colnames(umrli19)[2] <- "Opstina"
colnames(umrli20)[2] <- "Opstina"

umrli<- rbind(
      umrli15,
      umrli16,
      umrli17,
      umrli18,
      umrli19,
      umrli20
      )

rm(list = c("umrli15","umrli16","umrli17","umrli18","umrli19","umrli20"))
d <- as.data.frame(read.csv(file = "Mortalty Coding/Diagnosis2.txt",sep = "\t", quote = '""', header = F,stringsAsFactors = F, encoding = "UTF-8"))
d <- d[,1:5]
colnames(d) <- c("Chapter", "List", "Cause", "Title", "TilteSR")
d <- d[d$List==103,]

ch <- as.data.frame(read.csv(file = "Mortalty Coding/CodingChapters2.txt",sep = "\t", quote = '""', header = F, stringsAsFactors = F,encoding = "UTF-8"))
colnames(ch) <- c("Chapeter", "List", "Title", "TilteSR","TilteSRCyr")
ch <- ch[ch$List==103,c(1,3)]
colnames(ch)[1] <- "Chapter"
amenmort<- read_csv(file ="Mortalty Coding/amort.csv")
amenmort$Cause <- gsub(pattern = "[.]", replacement = "", x = amenmort$Cause)

ages<- list(
  `0-14`= 0:14,
  `0-19`= 0:19,
  `0-44`= 0:44,
  `0-74`= 0:74,
  `1-14`= 1:14,
  All = 1:150)

MortClassifier <-
  function(dataset = NULL,
           cause = NULL,
           age = NULL,
           ages = NULL,
           i=NULL) {
    if (nrow(amenmort[amenmort$Cause == cause, ]) != 0) {
      if (age %in% unlist(ages[as.character(amenmort[amenmort$Cause == cause, "AGE"])])) {
        return(cbind(data.frame(rn=i),amenmort[amenmort$Cause == cause, c(5, 6)]))
      }
      
    } else{
      if (nrow(amenmort[amenmort$Cause == substring(cause, 1, 3), ]) != 0) {
        if (age %in% unlist(ages[as.character(amenmort[amenmort$Cause == substring(cause, 1, 3), "AGE"])])) {
          return(cbind(data.frame(rn=i),amenmort[amenmort$Cause == substring(cause, 1, 3), c(5, 6)]))
        }
      }
    }
    return(data.frame(rn=i,Amenable = 0, Preventable = 0))
  }


require(foreach)
library(doParallel)

cl <- makeCluster(11)
registerDoParallel(cl)

s2<- data.frame(rn=1:nrow(umrli),Amenable = NA, Preventable = NA)
for (i in 1:nrow(umrli)) {
  s2[i,] <- MortClassifier(dataset = amenmort, cause=umrli$Uzrok.smrti[i],age = umrli$Starost[i], ages=ages,i=i )

}

  umrli<- cbind(umrli, s2)
  umrli$rn <- NULL
  umrli$Avoidable <- umrli$Preventable+ umrli$Amenable
  umrli$Avoidable <- ifelse(umrli$Avoidable>0, 1,0)

  write.xlsx(umrli, "umrli15-20Avoidable.xlsx") 
} else {
  umrli <- read.xlsx("umrli15-20Avoidable.xlsx")
}
pop <- read.csv("RZS/Populacija.csv", sep=";")
#Testiranje da li su podaci ok
umrli %>% group_by(Godina.materijala) %>% summarise(sum(Preventable))
umrli %>% group_by(Godina.materijala) %>% summarise(sum(Amenable))
umrli %>% group_by(Godina.materijala) %>% summarise(sum(Avoidable))

opstine<- read.csv(file = "Serbia Map/opstine.csv")



```

## Dodavanje podatka o broju stanovnika i računanje pokazatelja YPLL
U prvomd delu se učitavaju podaci o populaciji koji se mogu preuzeti sa portala otvorenih podataka RZS.
Takođe je U ovom delu je dato računanje pokazatelja izgubljenih godina potencijalnog života.


```{r standardization, echo=FALSE}

standpop<- read.xlsx("StPopSingleYear.xlsx")
standpop
standpop$stpop <- standpop$stpop/1000000
sum(standpop$stpop)-sum(standpop$stpop[1:75])
standardpop75<- standpop[1:75,]
standardpop75$stpop<- (standpop$stpop[1:75]/sum(standpop$stpop[1:75])* (sum(standpop$stpop)-sum(standpop$stpop[1:75])))+standpop$stpop[1:75]
standardpop75$stpop<-standardpop75$stpop/1000000
colnames(standardpop75)[1] <- "Starost"
YPLL_Age <- 75

standardized_YPLL_Covid<- left_join(
left_join(
    pop %>% filter(god == 2020, nPol == "Ukupno", !IDStarost %in% c("0","V85")) %>% mutate(Starost=as.integer(IDStarost)) %>% filter(Starost<75) %>% group_by(Opstina=IDTer, Starost) %>% summarise(Pop=sum(vrednost)),
  umrli %>% filter(
    Godina.materijala == 2020,
    Starost < YPLL_Age,
    Uzrok.smrti %in% c("U071", "U072")
  ) %>%
   mutate(Broj.pojava = ifelse(is.na(Broj.pojava),0, Broj.pojava)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Opstina, Starost) %>% summarise(YPLL = sum(YPLL)))%>%
   mutate(YPLL = ifelse(is.na(YPLL),0, YPLL)) %>% mutate(YPLLR=YPLL/Pop*100000), standardpop75) %>% group_by(Opstina) %>% summarise(YPLLi=sum(YPLLR*stpop,na.rm = T), YPLLR=sum(YPLL)/sum(Pop)*100000, YPLL=sum(YPLL), Pop=sum(Pop)) 


standardized_YPLL_NoN_Covid<- left_join(
left_join(
    pop %>% filter(god == 2020, nPol == "Ukupno", !IDStarost %in% c("0","V85")) %>% mutate(Starost=as.integer(IDStarost)) %>% filter(Starost<75) %>% group_by(Opstina=IDTer, Starost) %>% summarise(Pop=sum(vrednost)),
  umrli %>% filter(
    Godina.materijala == 2020,
    Starost < YPLL_Age
  ) %>%
   mutate(Broj.pojava = ifelse(is.na(Broj.pojava),0, Broj.pojava)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Opstina, Starost) %>% summarise(YPLL = sum(YPLL)))%>%
   mutate(YPLL = ifelse(is.na(YPLL),0, YPLL)) %>% mutate(YPLLR=YPLL/Pop*100000), standardpop75) %>% group_by(Opstina) %>% summarise(YPLLi=sum(YPLLR*stpop,na.rm = T), YPLLR=sum(YPLL)/sum(Pop)*100000, YPLL=sum(YPLL), Pop=sum(Pop)) 

standardized_YPLL_TOTAL<- left_join(
left_join(
    pop %>% filter(god == 2020, nPol == "Ukupno", !IDStarost %in% c("0","V85")) %>% mutate(Starost=as.integer(IDStarost)) %>% filter(Starost<75) %>% group_by(Opstina=IDTer, Starost) %>% summarise(Pop=sum(vrednost)),
  umrli %>% filter(
    Godina.materijala == 2020,
    Starost < YPLL_Age
  ) %>%
   mutate(Broj.pojava = ifelse(is.na(Broj.pojava),0, Broj.pojava)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Opstina, Starost) %>% summarise(YPLL = sum(YPLL)))%>%
   mutate(YPLL = ifelse(is.na(YPLL),0, YPLL)) %>% mutate(YPLLR=YPLL/Pop*100000), standardpop75) %>% group_by(Opstina) %>% summarise(YPLLi=sum(YPLLR*stpop,na.rm = T), YPLLR=sum(YPLL)/sum(Pop)*100000, YPLL=sum(YPLL), Pop=sum(Pop)) 

standardized_YPLL_Avoidable<- left_join(
left_join(
    pop %>% filter(god == 2020, nPol == "Ukupno", !IDStarost %in% c("0","V85")) %>% mutate(Starost=as.integer(IDStarost)) %>% filter(Starost<75) %>% group_by(Opstina=IDTer, Starost) %>% summarise(Pop=sum(vrednost)),
  umrli %>% filter(
    Godina.materijala == 2020, Avoidable==1,
    Starost < YPLL_Age
  ) %>%
   mutate(Broj.pojava = ifelse(is.na(Broj.pojava),0, Broj.pojava)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Opstina, Starost) %>% summarise(YPLL = sum(YPLL)))%>%
   mutate(YPLL = ifelse(is.na(YPLL),0, YPLL)) %>% mutate(YPLLR=YPLL/Pop*100000), standardpop75) %>% group_by(Opstina) %>% summarise(YPLLi=sum(YPLLR*stpop,na.rm = T), YPLLR=sum(YPLL)/sum(Pop)*100000, YPLL=sum(YPLL), Pop=sum(Pop)) 

standardized_YPLL_Preventable<- left_join(
left_join(
    pop %>% filter(god == 2020, nPol == "Ukupno", !IDStarost %in% c("0","V85")) %>% mutate(Starost=as.integer(IDStarost)) %>% filter(Starost<75) %>% group_by(Opstina=IDTer, Starost) %>% summarise(Pop=sum(vrednost)),
  umrli %>% filter(
    Godina.materijala == 2020,Preventable==1,
    Starost < YPLL_Age
  ) %>%
   mutate(Broj.pojava = ifelse(is.na(Broj.pojava),0, Broj.pojava)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Opstina, Starost) %>% summarise(YPLL = sum(YPLL)))%>%
   mutate(YPLL = ifelse(is.na(YPLL),0, YPLL)) %>% mutate(YPLLR=YPLL/Pop*100000), standardpop75) %>% group_by(Opstina) %>% summarise(YPLLi=sum(YPLLR*stpop,na.rm = T), YPLLR=sum(YPLL)/sum(Pop)*100000, YPLL=sum(YPLL), Pop=sum(Pop)) 


standardized_YPLL_Amenable<- left_join(
left_join(
    pop %>% filter(god == 2020, nPol == "Ukupno", !IDStarost %in% c("0","V85")) %>% mutate(Starost=as.integer(IDStarost)) %>% filter(Starost<75) %>% group_by(Opstina=IDTer, Starost) %>% summarise(Pop=sum(vrednost)),
  umrli %>% filter(
    Godina.materijala == 2020,Amenable==1, 
    Starost < YPLL_Age
  ) %>%
   mutate(Broj.pojava = ifelse(is.na(Broj.pojava),0, Broj.pojava)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Opstina, Starost) %>% summarise(YPLL = sum(YPLL)))%>%
   mutate(YPLL = ifelse(is.na(YPLL),0, YPLL)) %>% mutate(YPLLR=YPLL/Pop*100000), standardpop75) %>% group_by(Opstina) %>% summarise(YPLLi=sum(YPLLR*stpop,na.rm = T), YPLLR=sum(YPLL)/sum(Pop)*100000, YPLL=sum(YPLL), Pop=sum(Pop)) 


```

```{r YPLL, echo=FALSE}

#Populacija Srbije
popsr2020<-pop %>% filter(god == 2020, nPol == "Ukupno", !IDStarost %in% c("0","V85"), IDTer=="RS") %>% mutate(Starost=as.integer(IDStarost)) %>% filter(Starost<75) %>% group_by() %>% summarise(Pop=sum(vrednost))
popsr2019<-pop %>% filter(god == 2019, nPol == "Ukupno", !IDStarost %in% c("0","V85"), IDTer=="RS") %>% mutate(Starost=as.integer(IDStarost)) %>% filter(Starost<75) %>% group_by() %>% summarise(Pop=sum(vrednost))
popsr2018<-pop %>% filter(god == 2018, nPol == "Ukupno", !IDStarost %in% c("0","V85"), IDTer=="RS") %>% mutate(Starost=as.integer(IDStarost)) %>% filter(Starost<75) %>% group_by() %>% summarise(Pop=sum(vrednost))
popsr2017<-pop %>% filter(god == 2017, nPol == "Ukupno", !IDStarost %in% c("0","V85"), IDTer=="RS") %>% mutate(Starost=as.integer(IDStarost)) %>% filter(Starost<75) %>% group_by() %>% summarise(Pop=sum(vrednost))

popsr2020m<-pop %>% filter(god == 2020,  !IDStarost %in% c("0","V85"), IDTer=="RS", IDPol==1) %>% mutate(Starost=as.integer(IDStarost)) %>% filter(Starost<75) %>% group_by() %>% summarise(Pop=sum(vrednost))
popsr2020f<-pop %>% filter(god == 2020, !IDStarost %in% c("0","V85"), IDTer=="RS", IDPol==2) %>% mutate(Starost=as.integer(IDStarost)) %>% filter(Starost<75) %>% group_by() %>% summarise(Pop=sum(vrednost))



YPPL2020_C<- umrli %>% filter(
  Godina.materijala == 2020,
  Starost < YPLL_Age,
  Uzrok.smrti %in% c("U071", "U072")
) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL)) * 100000/popsr2020


YPPL2020_O <- umrli %>% filter(
  Godina.materijala == 2020,
  Starost < YPLL_Age,!Uzrok.smrti %in% c("U071", "U072"), Avoidable!=1) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL))* 100000/popsr2020

YPPL2020_Avoidable <- umrli %>% filter(
  Godina.materijala == 2020,
  Starost < YPLL_Age,Avoidable==1) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL))* 100000/popsr2020

umrli %>% filter(
  Godina.materijala == 2020,
  Starost < YPLL_Age,
) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL))* 100000/popsr2020


YPPL2019 <- umrli %>% filter(
  Godina.materijala == 2019,
  Starost < YPLL_Age, Avoidable!=1
) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL))* 100000/popsr2019

YPPL2019_Avoidable<- umrli %>% filter(
  Godina.materijala == 2019,
  Starost < YPLL_Age,Avoidable==1
) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL))* 100000/popsr2019


YPPL2018 <- umrli %>% filter(
  Godina.materijala == 2018,
  Starost < YPLL_Age, Avoidable!=1
) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL))* 100000/popsr2018

YPPL2018_Avoidable <- umrli %>% filter(
  Godina.materijala == 2018,
  Starost < YPLL_Age,Avoidable==1
) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL))* 100000/popsr2018


YPPL2017 <- umrli %>% filter(
  Godina.materijala == 2017,
  Starost < YPLL_Age, Avoidable!=1
) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL))* 100000/popsr2017

YPPL2017_Avoidable<- umrli %>% filter(
  Godina.materijala == 2017,
  Starost < YPLL_Age, Avoidable==1
) %>%
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL))* 100000/popsr2017




umrli %>% filter(
  Godina.materijala == 2020,
  Uzrok.smrti %in% c("U071", "U072")
) %>% filter((Pol=="1" & Starost<65) |(Pol=="2" & Starost<63) ) %>% 
  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL))


  covid_bar_plot <-
    data.frame(
      Year = c(2017,2017, 2018,2018,2019,2019, 2020,2020, 2020),
      Type = c("Other","Avoidable", "Other", "Avoidable", "Other", "Avoidable", "SARS-CoV-2", "Avoidable","Other"),
      YPLL = unname(c(
        unlist(YPPL2017),
        unlist(YPPL2017_Avoidable),
        unlist(YPPL2018),
        unlist(YPPL2018_Avoidable),
        unlist(YPPL2019),
        unlist(YPPL2019_Avoidable),
        unlist(YPPL2020_C),
        unlist(YPPL2020_Avoidable),
        unlist(YPPL2020_O)
      ))
    )
  covid_bar_plot$Type <- factor(covid_bar_plot$Type, levels =c("SARS-CoV-2", "Other","Avoidable") )



  fig2plos <-  ggplot(covid_bar_plot ,aes(x=Year, y=YPLL, fill=Type))+
  geom_bar(position="stack", stat="identity")+ coord_flip()+
  scale_fill_manual(values = c("#d95f02","#1b9e77", "#7570b3" ))+# c( "#abdda4", "#2b83ba", "#d7191c"))+
  #guides(NULL)+
  theme_tufte()+ #theme(legend.position = "none",text=element_text(size=10,  family="TT Arial"))+
    theme(text=element_text(size=10,  family="TT Arial"))+
     scale_y_continuous(breaks = c(2000, 4000, 6000, 8000, 10000))+
  #annotate("text", x=2020, y=9150,label="COVID-19", size=2.5, angle = 90, color="black" )+
     geom_hline(yintercept =c(2000, 4000, 6000, 8000, 10000),lwd=1, color="white")+
  ylab("Izgubljene godine potencijalnog života na 100.000 stanovnika")+
      xlab(NULL)
  fig2plos
   
    # ggsave(fig2plos,filename = "Figure2plos.svg", units = "mm", width = 175, height = 50)
    # ggsave(fig2plos,filename = "figure2plos.png", units = "mm", width = 175, height = 50)
    # ggsave(fig2plos,filename = "figure2plos.jpg", units = "mm", width = 175, height = 50, dpi = 600)
    # 
    
    standardized_YPLL_Covid %>% group_by() %>% summarise(CV=sd(YPLLR)/
                                                      mean(YPLLR))
    
    standardized_YPLL_NoN_Covid %>% group_by() %>% summarise(CV=sd(YPLLR)/
                                                      mean(YPLLR))
    
    standardized_YPLL_TOTAL  %>%group_by() %>% summarise(CV=sd(YPLLR)/
                                                         mean(YPLLR))
    
    
    #CPL
    
    GDPPC2020 <- 7742
    
  YPPLL<-   
    umrli %>% filter(
      Godina.materijala == 2020,
      Uzrok.smrti %in% c("U071", "U072")
    ) %>% filter((Pol=="2" & Starost<15)) %>% group_by() %>%  summarise(sum(Broj.pojava))*(63-15)+
    umrli %>% filter(
      Godina.materijala == 2020,
      Uzrok.smrti %in% c("U071", "U072")
    ) %>% filter((Pol=="1" & Starost<15)) %>% group_by() %>%  summarise(sum(Broj.pojava))*(65-15)+
    

    umrli %>% filter(
      Godina.materijala == 2020,
      Uzrok.smrti %in% c("U071", "U072")
    ) %>% filter((Pol=="1" & Starost>=15 & Starost<65)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL))+
    
    umrli %>% filter(
      Godina.materijala == 2020,
      Uzrok.smrti %in% c("U071", "U072")
    ) %>% filter((Pol=="2" & Starost>=15 & Starost<63)) %>%  mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by() %>% summarise(YPLL = sum(YPLL))
    
    #
    CPL= YPPLL*GDPPC2020
    
    
    #Correlation test
    forcor<- left_join(standardized_YPLL_NoN_Covid, standardized_YPLL_Covid, by="Opstina")
cor.test(forcor$YPLLR.x, forcor$YPLLR.y, method="spearman") 

```

```{r specificne_stope_smrtnosti_COVID, echo=FALSE}


left_join(
umrli %>% filter(
  Godina.materijala == 2020,
  Starost < 999,
  Uzrok.smrti %in% c("U071", "U072")
) %>% dplyr::mutate(Starost=car::recode(Starost,'c("85", "86", "87", "88", 
"89", "90", "91", "92", "93", "94", "95", "96", "97", "98", "99", 
"100", "101", "102", "103", "104", "105", "106", "107", "108", 
"109", "111", "112", "114", "999")="85"'))%>% group_by(Starost,Pol) %>% summarise(Smrti=sum(Broj.pojava)),
pop %>% filter(god==2020, IDTer=="RS",IDPol!=0, IDStarost!=0) %>% mutate(Starost=c(0:85,0:85) , Pol=as.character(IDPol))) %>% 
  mutate(`Specifična stopa smrtnosti`=Smrti/vrednost*1000, Pol=ifelse(Pol=="1","Muški", "Ženski")) %>% ggplot() + geom_line(aes(x=Starost, y=`Specifična stopa smrtnosti`, col=Pol)) + theme_tufte()


left_join(
umrli %>% filter(
  Godina.materijala == 2019,
  Starost < 999,
 # Uzrok.smrti %in% c("U071", "U072")
) %>% dplyr::mutate(Starost=car::recode(Starost,'c("85", "86", "87", "88", 
"89", "90", "91", "92", "93", "94", "95", "96", "97", "98", "99", 
"100", "101", "102", "103", "104", "105", "106", "107", "108", 
"109", "111", "112", "114", "999")="85"'))%>% group_by(Starost,Pol) %>% summarise(Smrti=sum(Broj.pojava)),
pop %>% filter(god==2019, IDTer=="RS",IDPol!=0, IDStarost!=0) %>% mutate(Starost=c(0:85,0:85) , Pol=as.character(IDPol))) %>% 
  mutate(`Specifična stopa smrtnosti`=Smrti/vrednost*1000, Pol=ifelse(Pol=="1","Muški", "Ženski")) %>% ggplot() + geom_line(aes(x=Starost, y=`Specifična stopa smrtnosti`, col=Pol)) + theme_tufte()


```
##GIS Analiza
U ovom delu koristimo moranov globalni i lokalni indeks.

```{r GIS, echo=FALSE}


Serbia<- readShapePoly("SRdrMap/Serbia.shp")
SRMAP<- fortify(Serbia, region = "code")
SRMAP$region <- SRMAP$id

Serbia@data$code[39] <- 71366





spatial_processing <- function(map=NULL,foritfied_map=NULL,motality_dataframe=NULL, variable=NULL ) {
  nb<- poly2nb(map, queen=TRUE)
lw <- nb2listw(nb, style="W", zero.policy=TRUE)
  
  x<- left_join(data.frame(Opstina=as.character(map@data$code)), motality_dataframe, by="Opstina")
locmor<- localmoran(unname(unlist(c(x[,variable]))),lw,p.adjust.method = "bonferroni")
locmor<- as.data.frame(locmor)
return(left_join(foritfied_map, data.frame(Opstina=as.character(map@data$code), Ii=locmor$Ii, Pat=ifelse(locmor$`Pr(z != E(Ii))` < 0.05,"stripe", "none")), by=c("region"="Opstina")))
}


#Final Avoidable map



ggplotdata <- spatial_processing(map=Serbia,foritfied_map = SRMAP,motality_dataframe = standardized_YPLL_Avoidable, variable = "YPLLi")

ggplot(data=left_join(SRMAP, standardized_YPLL_Avoidable, by=c("region"="Opstina")), aes(x=long, y=lat))+
    geom_map(map = SRMAP,aes(map_id=id, x=long, y=lat,fill=round(YPLLR,0), group=group,label=region ),color="#808080",na.rm = F)+
  coord_map("mercator")+
  #scale_fill_con(type = "div", palette = "RdYlGn", direction = -1)+
  #scale_fill_gradient(low = "#FFFFFF", high = "#000000",na.value = "#FFFFFF")+
  scale_fill_distiller(palette = "Reds",direction = 1)+
  guides(fill = guide_colorsteps(show.limits = T,frame.linewidth=2,ticks.colour="#808080",frame.linetype=1,frame.colour="#808080",ticks = T,even.steps = T,title="Years per 100 000\nof people under 75"))+
  #labs(caption="© OpenStreetMap contributors")+ 
  #guides(fill=guide_legend()+
  theme_tufte() + theme(legend.position=c(.80,.85),text=element_text(size=10,  family="TT Arial"),legend.title=element_text(margin = margin(b = 10, unit = "pt"))) +
  xlab(NULL)+ylab(NULL)+ theme(axis.title.x=element_blank(),
                               axis.text.x=element_blank(),
                               axis.ticks.x=element_blank(),axis.title.y=element_blank(),
                               axis.text.y=element_blank(),
                               axis.ticks.y=element_blank())+
  # geom_polygon(data = Kosovo, aes(x = long, y =  lat, group = group), color = "#808080", alpha = 0, linetype = 1)+
  labs(caption="© OpenStreetMap contributors")+
  geom_map_pattern(
    map = SRMAP,
    aes(map_id=id),
    pattern =ggplotdata$Pat ,
    pattern_alpha= 0.8,
    pattern_aspect_ratio = 1.75,
    pattern_density= 0.1,
    pattern_spacing	= 0.01, 
    fill = NA, pattern_color = "#000000",pattern_fill = "#000000"
  )
##########################################Avoidable

YPLL_Opstine_Avoidable<- left_join(
  umrli %>% filter(
    Godina.materijala == 2020,
    Starost < YPLL_Age,
    Avoidable==1
  ) %>%
    mutate(YPLL = (YPLL_Age - Starost) * Broj.pojava) %>% group_by(Opstina) %>% summarise(YPLL = sum(YPLL))
  ,
  pop %>% filter(god == 2020, nPol == "Ukupno", !IDStarost %in% c("0","V85")) %>% mutate(Starost=as.integer(IDStarost)) %>% filter(Starost<75) %>% group_by(Opstina=IDTer) %>% summarise(Pop=sum(vrednost))
  
) %>% mutate(YPLLR=YPLL/Pop*100000)

Serbia@data$code[39] <- 71366
nb<- poly2nb(Serbia, queen=TRUE)
lw <- nb2listw(nb, style="W", zero.policy=TRUE)

spatial_Avoidalbe<- left_join(data.frame(Opstina=as.character(Serbia@data$code)), YPLL_Opstine_Avoidable, by="Opstina")

moran.test(spatial_Avoidalbe$YPLLR,lw)

locmor<- localmoran(spatial_Avoidalbe$YPLLR,lw,p.adjust.method = "bonferroni")
locmor<- as.data.frame(locmor)

ggplotdata <-
  left_join(
    SRMAP,
    data.frame(
      Opstina = as.character(Serbia@data$code),
      Ii = locmor$Ii,
      Pat = ifelse(locmor$`Pr(z != E(Ii))` < 0.1, "circle", "none")
    ),
    by = c("region" = "Opstina")
  )

ggplotdata <- ggplotdata %>% mutate(Pat= ifelse(Ii>0 & Pat=="circle","stripe", Pat))

Belgrade<- subset(Serbia,Serbia@data$Region=="Belgrade" )
Belgrade<- fortify(Belgrade,  region = "code")

BgMap<- ggplot(data=left_join(Belgrade, YPLL_Opstine_Avoidable, by=c("id"="Opstina")) , aes(x=long, y=lat))+
  geom_map(map = Belgrade,aes(map_id=id, x=long, y=lat,fill=round(YPLLR,0), group=group ),color="#808080",na.rm = F)+
  coord_map("mercator", ylim= c(44.30,45.1), xlim = c(20.0, 20.9))+
  scale_fill_distiller(palette = "Oranges",direction = 1)+
  theme_tufte() + theme(legend.position=c(.80,.85),text=element_text(size=10,  family="TT Arial"),legend.title=element_text(margin = margin(b = 10, unit = "pt"))) +
  xlab(NULL)+ylab(NULL)+ theme(axis.title.x=element_blank(),
                               axis.text.x=element_blank(),
                               axis.ticks.x=element_blank(),axis.title.y=element_blank(),
                               axis.text.y=element_blank(),
                               axis.ticks.y=element_blank())+
  geom_map_pattern(
    map = left_join(Belgrade, YPLL_Opstine_Avoidable, by=c("id"="Opstina")),
    aes(map_id=id),
    pattern =ggplotdata[ggplotdata$region %in%opstine$Code[opstine$Region=="Belgrade"], "Pat" ] ,
    pattern_alpha= 0.8,
    pattern_aspect_ratio = 1.75,
    pattern_density= 0.01,
    pattern_spacing	= 0.05, 
    fill = NA, pattern_color = "#000000",pattern_fill = "#000000",
  )+ guides(fill=FALSE)

ggsave(BgMap,filename =  "bgavoidmap.svg", units = "mm", width = 175)


library(cowplot)

avoid_map<- ggplot(data=left_join(SRMAP, YPLL_Opstine_Avoidable, by=c("region"="Opstina")), aes(x=long, y=lat, pattern=ggplotdata$Pat))+
  geom_map(map = SRMAP,aes(map_id=id, x=long, y=lat,fill=round(YPLLR,0), group=group ),color="#808080",na.rm = F)+
  coord_map("mercator")+
  #scale_fill_con(type = "div", palette = "RdYlGn", direction = -1)+
  #scale_fill_gradient(low = "#FFFFFF", high = "#000000",na.value = "#FFFFFF")+
  scale_fill_distiller(palette = "Oranges",direction = 1)+
 guides(fill = guide_colorsteps(show.limits = T,frame.linewidth=2,ticks.colour="#808080",frame.linetype=1,frame.colour="#808080",ticks = T,even.steps = T,title="Years per 100 000\nof people under 75"))+
  #labs(caption="© OpenStreetMap contributors")+ 
  #guides(fill=guide_legend())+
  theme_tufte() + theme(legend.position=c(.80,.85),text=element_text(size=10,  family="TT Arial"),legend.title=element_text(margin = margin(b = 10, unit = "pt"))) +
  xlab(NULL)+ylab(NULL)+ theme(axis.title.x=element_blank(),
                               axis.text.x=element_blank(),
                               axis.ticks.x=element_blank(),axis.title.y=element_blank(),
                               axis.text.y=element_blank(),
                               axis.ticks.y=element_blank())+
  # geom_polygon(data = Kosovo, aes(x = long, y =  lat, group = group), color = "#808080", alpha = 0, linetype = 1)+
  labs(caption="© OpenStreetMap contributors")+
  geom_map_pattern(
    map = SRMAP,
    aes(map_id=id),
    #pattern =ggplotdata$Pat ,
    pattern_alpha= 0.8,
    pattern_aspect_ratio = 1.75,
    pattern_density= 0.1,
    pattern_spacing	= 0.01, 
    fill = NA, pattern_color = "#000000",pattern_fill = "#000000",show.legend = T
  ) + scale_pattern_type_manual(values = c("circle","stripe"))

avoid_map
ggsave(avoid_map,filename =  "avoid_map.svg", units = "mm", width = 175)
ggsave(avoid_map,filename =  "avoid_map.eps", units = "mm", width = 175)
ggsave(avoid_map,filename =  "avoid_map.pdf", units = "mm", width = 175)

Serbia@data$area <- raster::area(Serbia)/1000000



TestCorAvoidArea<- left_join(Serbia@data %>% mutate(code=as.character(code)), YPLL_Opstine_Avoidable, by=c("code"="Opstina"))

cor.test(TestCorAvoidArea$Pop/TestCorAvoidArea$area,TestCorAvoidArea$YPLLR,method = "spearman")



```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
